# ç±»åŠ è½½å’Œå­—èŠ‚ç æŠ€æœ¯

<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\20200608151300.png" alt="img" style="zoom: 80%;" />

## 1.å­—èŠ‚ç æŒ‡ä»¤

### 1. ç±»æ–‡ä»¶ç»“æ„

é¦–å…ˆè·å¾—.classå­—èŠ‚ç æ–‡ä»¶

æ–¹æ³•(ç¼–è¯‘ä¸€ä¸‹)ï¼š

- åœ¨æ–‡æœ¬æ–‡æ¡£é‡Œå†™å…¥javaä»£ç ï¼ˆæ–‡ä»¶åä¸ç±»åä¸€è‡´ï¼‰ï¼Œå°†æ–‡ä»¶ç±»å‹æ”¹ä¸º.java
- javaç»ˆç«¯ä¸­ï¼Œæ‰§è¡Œjavac X:...\XXX.java

å¦‚ä¸‹:

```
0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 09 
0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b 07 
0000040 00 1c 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29 
0000060 56 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e 
0000100 75 6d 62 65 72 54 61 62 6c 65 01 00 12 4c 6f 63 
0000120 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65 01 
0000140 00 04 74 68 69 73 01 00 1d 4c 63 6e 2f 69 74 63 
0000160 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c 6f 
0000200 57 6f 72 6c 64 3b 01 00 04 6d 61 69 6e 01 00 16 
0000220 28 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 
0000240 69 6e 67 3b 29 56 01 00 04 61 72 67 73 01 00 13 
0000260 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 
0000300 6e 67 3b 01 00 10 4d 65 74 68 6f 64 50 61 72 61 
0000320 6d 65 74 65 72 73 01 00 0a 53 6f 75 72 63 65 46 
0000340 69 6c 65 01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64
0000360 2e 6a 61 76 61 0c 00 07 00 08 07 00 1d 0c 00 1e 
0000400 00 1f 01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64 
0000420 07 00 20 0c 00 21 00 22 01 00 1b 63 6e 2f 69 74 
0000440 63 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c 
0000460 6f 57 6f 72 6c 64 01 00 10 6a 61 76 61 2f 6c 61 
0000500 6e 67 2f 4f 62 6a 65 63 74 01 00 10 6a 61 76 61 
0000520 2f 6c 61 6e 67 2f 53 79 73 74 65 6d 01 00 03 6f 
0000540 75 74 01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72 
0000560 69 6e 74 53 74 72 65 61 6d 3b 01 00 13 6a 61 76 
0000600 61 2f 69 6f 2f 50 72 69 6e 74 53 74 72 65 61 6d 
0000620 01 00 07 70 72 69 6e 74 6c 6e 01 00 15 28 4c 6a 
0000640 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b 
0000660 29 56 00 21 00 05 00 06 00 00 00 00 00 02 00 01 
0000700 00 07 00 08 00 01 00 09 00 00 00 2f 00 01 00 01 
0000720 00 00 00 05 2a b7 00 01 b1 00 00 00 02 00 0a 00 
0000740 00 00 06 00 01 00 00 00 04 00 0b 00 00 00 0c 00 
0000760 01 00 00 00 05 00 0c 00 0d 00 00 00 09 00 0e 00 
0001000 0f 00 02 00 09 00 00 00 37 00 02 00 01 00 00 00 
0001020 09 b2 00 02 12 03 b6 00 04 b1 00 00 00 02 00 0a 
0001040 00 00 00 0a 00 02 00 00 00 06 00 08 00 07 00 0b 
0001060 00 00 00 0c 00 01 00 00 00 09 00 10 00 11 00 00 
0001100 00 12 00 00 00 05 01 00 10 00 00 00 01 00 13 00 
0001120 00 00 02 00 14
```

æ ¹æ® JVM è§„èŒƒï¼Œ**ç±»æ–‡ä»¶ç»“æ„**å¦‚ä¸‹

```java
u4 			 magic
u2             minor_version;    
u2             major_version;    
u2             constant_pool_count;    
cp_info        constant_pool[constant_pool_count-1];    
u2             access_flags;    
u2             this_class;    
u2             super_class;   
u2             interfaces_count;    
u2             interfaces[interfaces_count];   
u2             fields_count;    
field_info     fields[fields_count];   
u2             methods_count;    
method_info    methods[methods_count];    
u2             attributes_count;    
attribute_info attributes[attributes_count];
```

#### é­”æ•°

u4 magic

å¯¹åº”å­—èŠ‚ç æ–‡ä»¶çš„0~3ä¸ªå­—èŠ‚,å®ƒè¡¨ç¤ºæ˜¯å¦æ˜¯[class]ç±»å‹çš„æ–‡ä»¶

0000000 **ca fe ba be** 00 00 00 34 00 23 0a 00 06 00 15 09

#### ç‰ˆæœ¬

u2 minor_version;

u2 major_version;

0000000 ca fe ba be **00 00 00 34** 00 23 0a 00 06 00 15 09

34H = 52ï¼Œä»£è¡¨JDK8

#### å¸¸é‡æ± 

##### å¸¸é‡ç±»å‹

| Constant Type               | Value |
| --------------------------- | ----- |
| CONSTANT_Class              | 7     |
| CONSTANT_Fieldref           | 9     |
| CONSTANT_Methodref          | 10    |
| CONSTANT_InterfaceMethodref | 11    |
| CONSTANT_String             | 8     |
| CONSTANT_Integer            | 3     |
| CONSTANT_Float              | 4     |
| CONSTANT_Long               | 5     |
| CONSTANT_Double             | 6     |
| CONSTANT_NameAndType        | 12    |
| CONSTANT_Utf8               | 1     |
| CONSTANT_MethodHandle       | 15    |
| CONSTANT_MethodType         | 16    |
| CONSTANT_InvokeDynamic      | 18    |

### 2. å­—èŠ‚ç æŒ‡ä»¤

#### javapå·¥å…·

Oracle æä¾›äº† **javap** å·¥å…·æ¥åç¼–è¯‘ class æ–‡ä»¶

javap -v Main.class

```json
PS D:\A.Code\A.project\jvmtest\target\classes\org\snbo\complier> javap -v TestMain.class 
Classfile /D:/A.Code/A.project/jvmtest/target/classes/org/snbo/complier/TestMain.class
  Last modified 2022-8-17; size 563 bytes
  MD5 checksum afd1b9bbe015ddebd5153f1bf741dd0c
  Compiled from "TestMain.java"
public class org.snbo.complier.TestMain
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #6.#20         // java/lang/Object."<init>":()V  
                                          # æ–¹æ³•å¼•ç”¨: Objectç±»çš„initæ–¹æ³•, (): æ— å‚ V: æ— è¿”å›å€¼
   #2 = Fieldref           #21.#22        // java/lang/System.out:Ljava/io/PrintStream; 
                                          # å˜é‡å¼•ç”¨: Systemç±»é‡Œçš„outå˜é‡,å˜é‡ç±»å‹æ˜¯PrintStream
   #3 = String             #23            // Hello World
   #4 = Methodref          #24.#25        // java/io/PrintStream.println:(Ljava/lang/String;)V 
                                          # æ–¹æ³•å¼•ç”¨: PrintStreamç±»çš„printlnæ–¹æ³•,Stringç±»å‹çš„å‚æ•°,ç©ºè¿”å›å€¼
   #5 = Class              #26            // org/snbo/complier/TestMain
   #6 = Class              #27            // java/lang/Object
   #7 = Utf8               <init>
   #8 = Utf8               ()V
   #9 = Utf8               Code
  #10 = Utf8               LineNumberTable
  #11 = Utf8               LocalVariableTable
  #12 = Utf8               this
  #13 = Utf8               Lorg/snbo/complier/TestMain;
  #14 = Utf8               main
  #15 = Utf8               ([Ljava/lang/String;)V
  #16 = Utf8               args
  #17 = Utf8               [Ljava/lang/String;
  #18 = Utf8               SourceFile
  #19 = Utf8               TestMain.java
  #20 = NameAndType        #7:#8          // "<init>":()V
  #21 = Class              #28            // java/lang/System
  #22 = NameAndType        #29:#30        // out:Ljava/io/PrintStream;
  #23 = Utf8               Hello World
  #24 = Class              #31            // java/io/PrintStream
  #25 = NameAndType        #32:#33        // println:(Ljava/lang/String;)V
  #26 = Utf8               org/snbo/complier/TestMain
  #27 = Utf8               java/lang/Object
  #28 = Utf8               java/lang/System
  #29 = Utf8               out
  #30 = Utf8               Ljava/io/PrintStream;
  #31 = Utf8               java/io/PrintStream
  #32 = Utf8               println
  #33 = Utf8               (Ljava/lang/String;)V
{
  public org.snbo.complier.TestMain();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         # å°†å±€éƒ¨å˜é‡çš„ç¬¬ 0 é¡¹åŠ å…¥åˆ°æ“ä½œæ•°æ ˆ
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         # æ‰§è¡Œæ–¹æ³•Object.<init>: Objectçš„ç©ºå‚æ„é€ æ–¹æ³•
         4: return
         # è¿”å›å€¼ä¸ºç©º
      LineNumberTable:
        line 7: 0 // æºä»£ç çš„ç¬¬7è¡Œå¯¹åº”å­—èŠ‚ç çš„ç¬¬0è¡Œ
      LocalVariableTable:
      # æœ¬åœ°å˜é‡è¡¨
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lorg/snbo/complier/TestMain;

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=1, args_size=1
     # æ ˆæ·±åº¦  å±€éƒ¨å˜é‡ä¸ªæ•° å‚æ•°ä¸ªæ•° 
         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;
         # å–é™æ€å˜é‡
         3: ldc           #3                  // String hello world
         # åŠ è½½å¸¸é‡æ± ä¸­çš„ #3 å¸¸é‡
         5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
         # æ‰§è¡Œæ–¹æ³•PrintStream.println: å‚æ•°ä¸ºString,è¿”å›å€¼ä¸ºç©º
         8: return
      LineNumberTable:
        line 9: 0
        line 10: 8
      LocalVariableTable:
      Start  Length  Slot  Name   Signature
          0       9     0  args   [Ljava/lang/String;
}
SourceFile: "TestMain.java"

```

### 3. æ–¹æ³•æ‰§è¡Œæµç¨‹

1) åŸå§‹ java ä»£ç 

```java
package org.snbo;

public class MainTest {
    public static void main(String[] args) {
        int a = 10;
        int b = Short.MAX_VALUE + 1;
        int c = a + b;
        System.out.println(c);
    }
}
```

2. ç¼–è¯‘åçš„å­—èŠ‚ç æ–‡ä»¶

```java
Classfile /D:/A.Code/A.project/jvmtest/target/classes/org/snbo/MainTest.class
  Last modified 2022-8-17; size 604 bytes
  MD5 checksum ddcceb7901a0d767371431cfbf2d015a
  Compiled from "MainTest.java"
public class org.snbo.MainTest
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #7.#25         // java/lang/Object."<init>":()V
   #2 = Class              #26            // java/lang/Short
   #3 = Integer            32768
   #4 = Fieldref           #27.#28        // java/lang/System.out:Ljava/io/PrintStream;
   #5 = Methodref          #29.#30        // java/io/PrintStream.println:(I)V
   #6 = Class              #31            // org/snbo/MainTest
   #7 = Class              #32            // java/lang/Object
   #8 = Utf8               <init>
   #9 = Utf8               ()V
  #10 = Utf8               Code
  #11 = Utf8               LineNumberTable
  #12 = Utf8               LocalVariableTable
  #13 = Utf8               this
  #14 = Utf8               Lorg/snbo/MainTest;
  #15 = Utf8               main
  #16 = Utf8               ([Ljava/lang/String;)V
  #17 = Utf8               args
  #18 = Utf8               [Ljava/lang/String;
  #19 = Utf8               a
  #20 = Utf8               I
  #21 = Utf8               b
  #22 = Utf8               c
  #23 = Utf8               SourceFile
  #24 = Utf8               MainTest.java
  #25 = NameAndType        #8:#9          // "<init>":()V
  #26 = Utf8               java/lang/Short
  #27 = Class              #33            // java/lang/System
  #28 = NameAndType        #34:#35        // out:Ljava/io/PrintStream;
  #29 = Class              #36            // java/io/PrintStream
  #30 = NameAndType        #37:#38        // println:(I)V
  #31 = Utf8               org/snbo/MainTest
  #32 = Utf8               java/lang/Object
  #33 = Utf8               java/lang/System
  #34 = Utf8               out
  #35 = Utf8               Ljava/io/PrintStream;
  #36 = Utf8               java/io/PrintStream
  #37 = Utf8               println
  #38 = Utf8               (I)V
{
  public org.snbo.MainTest();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 4: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lorg/snbo/MainTest;

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=4, args_size=1
         0: bipush        10
         2: istore_1
         3: ldc           #3                  // int 32768
         5: istore_2
         6: iload_1
         7: iload_2
         8: iadd
         9: istore_3
        10: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;
            3      15     1     a   I
            6      12     2     b   I
           10       8     3     c   I
}
SourceFile: "MainTest.java"

```

3. **å¸¸é‡æ± è½½å…¥è¿è¡Œæ—¶å¸¸é‡æ± **

   <img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220817203957639.png" alt="image-20220817203957639" style="zoom:80%;" />

- æ•´æ•°å€¼å°äº Short.MAX_VALUE çš„å€¼è·Ÿç€æ–¹æ³•çš„å­—èŠ‚ç æŒ‡ä»¤å­˜å‚¨åœ¨ä¸€èµ·,æ•°å€¼å¤§äº MAX_VALUE çš„ä¼šå­˜å‚¨åœ¨å¸¸é‡æ± 

4. **æ–¹æ³•çš„å­—èŠ‚ç è½½å…¥æ–¹æ³•åŒº**

   <img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220817203936560.png" alt="image-20220817203936560" style="zoom:80%;" />

5. **main çº¿ç¨‹å¼€å§‹è¿è¡Œï¼Œåˆ†é…æ ˆå¸§å†…å­˜**

   ï¼ˆstack=2ï¼Œlocals=4ï¼‰: æ·±åº¦æ˜¯2çš„æ“ä½œæ•°æ ˆ,ç”¨æ¥**å­˜å‚¨æ•°æ®å’Œå­—èŠ‚ç æŒ‡ä»¤**, 4ä¸ªæ§½ä½çš„**å±€éƒ¨å˜é‡è¡¨**

     stack = 2, æ“ä½œæ•°æ ˆæœ‰ä¸¤ä¸ªç©ºé—´,ä¸€ä¸ªç©ºé—´ 4 ä¸ªå­—èŠ‚

   <img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220817204536564.png" alt="image-20220817204536564" style="zoom:80%;" />

6. **æ‰§è¡Œå¼•æ“å¼€å§‹æ‰§è¡Œå­—èŠ‚ç **

   **æ‰§è¡Œå¼•æ“å¼€å§‹ä¸€æ­¥æ­¥ä»æ–¹æ³•åŒºè¯»å– main æ–¹æ³•ä¸­çš„å­—èŠ‚ç æŒ‡ä»¤,å¼€å§‹è¿è¡Œ**

**bipush 10**

- å°†ä¸€ä¸ª byte å‹å…¥æ“ä½œæ•°æ ˆï¼ˆå…¶é•¿åº¦ä¼šè¡¥é½ 4 ä¸ªå­—èŠ‚ï¼‰ï¼Œç±»ä¼¼çš„æŒ‡ä»¤è¿˜æœ‰
  - sipush å°†ä¸€ä¸ª short å‹å…¥æ“ä½œæ•°æ ˆï¼ˆå…¶é•¿åº¦ä¼šè¡¥é½ 4 ä¸ªå­—èŠ‚ï¼‰
  - ldc æ¥æ”¶8ä½å‚æ•°ï¼ŒæŒ‡å‘å¸¸é‡æ± ä¸­çš„intã€floatæˆ–Stringï¼Œå°†å¸¸é‡æ± ä¸­æŒ‡å®šå†…å®¹å‹å…¥æ ˆï¼ˆæ ¹æ®ç´¢å¼•æœç´¢ï¼‰
  - ldc_w æ¥æ”¶16ä½å‚æ•°ï¼Œç´¢å¼•å¸¸é‡æ± çš„èŒƒå›´æ›´å¤§
  - ldc2_w æ¥æ”¶ä¸¤ä¸ª 8 ä½æ•°ï¼Œç´¢å¼•èŒƒå›´æ›´å¤§,ç”¨äºå‹å¦‚å…¥ long ç±»å‹å’Œ double ç±»å‹çš„æ•°æ®(åˆ†ä¸¤æ¬¡å‹å…¥)
  - è¿™é‡Œå°çš„æ•°å­—éƒ½æ˜¯å’Œå­—èŠ‚ç æŒ‡ä»¤å­˜åœ¨ä¸€èµ·ï¼Œ**è¶…è¿‡ short èŒƒå›´çš„æ•°å­—å­˜å…¥äº†å¸¸é‡æ± **

**istore 1**

å°†æ“ä½œæ•°ä»æ ˆé¡¶å¼¹å‡º,æ”¾å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 1 ä¸­

å¯¹åº”ä»£ç : int a = 10;

<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220817211807252.png" alt="image-20220817211807252" style="zoom: 67%;" />



**Idc #3**

- ä»å¸¸é‡æ± åŠ è½½ #3 æ•°æ®åˆ°æ“ä½œæ•°æ ˆ
- æ³¨æ„ Short.MAX_VALUE æ˜¯ 32767ï¼Œæ‰€ä»¥ 32768 = Short.MAX_VALUE + 1 å®é™…æ˜¯åœ¨ç¼–è¯‘æœŸé—´è®¡ç®—
  å¥½çš„

<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220817213525991.png" alt="image-20220817213525991" style="zoom:80%;" />



**istore_2**

ä»æ ˆé¡¶å¼¹å‡ºæ•°æ®æ”¾å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 2 ä¸­

å¯¹åº”ä»£ç : int b = Short.MAX_VALUE + 1;

<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220817213905431.png" alt="image-20220817213905431" style="zoom:80%;" />



**iload_1**

è¯»å–å±€éƒ¨å˜é‡è¡¨ä¸­ slot 1 æ“ä½œæ•°çš„å€¼,å…¥æ ˆ



**iload_2**

è¯»å–å±€éƒ¨å˜é‡è¡¨ä¸­ slot_2 æ“ç»„æ•°çš„å€¼,å…¥æ ˆ



**iadd**

å°†æ ˆé¡¶çš„ä¸¤ä¸ªæ“ä½œæ•°å‡ºæ ˆç›¸åŠ ,å†ç»“æœå…¥æ ˆ

<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220817214810370.png" alt="image-20220817214810370" style="zoom:67%;" />

**istore_3**

å°†æ ˆé¡¶æ“ä½œæ•°å‡ºæ ˆæ”¾å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 3 ä¸­



getstatic #4

é€šè¿‡å¸¸é‡æ± ä¸­çš„å˜é‡å¼•ç”¨ä¿¡æ¯,è·å–åˆ°å †ä¸­çš„å¯¹è±¡çš„å¼•ç”¨,å°†è¯¥å¼•ç”¨å…¥æ ˆ

<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220817215952556.png" alt="image-20220817215952556" style="zoom:67%;" />



<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220817220014975.png" alt="image-20220817220014975" style="zoom:67%;" />



**iload_3**

è¯»å–å±€éƒ¨å˜é‡è¡¨ä¸­ slot 3 æ“ä½œæ•°çš„å€¼,å…¥æ ˆ



**invokevirtual #5**

- æ‰¾åˆ°å¸¸é‡æ±  #5 é¡¹
- å®šä½åˆ°æ–¹æ³•åŒº java/io/PrintStream.println:(I)V æ–¹æ³•
- ç”Ÿæˆæ–°çš„æ ˆå¸§ï¼ˆåˆ†é… localsã€stackç­‰ï¼‰
- ä¼ é€’å‚æ•°ï¼Œæ‰§è¡Œæ–°æ ˆå¸§ä¸­çš„å­—èŠ‚ç 

<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220817220754378.png" alt="image-20220817220754378" style="zoom: 80%;" />

- æ‰§è¡Œå®Œæ¯•ï¼Œå¼¹å‡ºæ ˆå¸§
- æ¸…é™¤ main æ“ä½œæ•°æ ˆå†…å®¹

<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220817220925718.png" alt="image-20220817220925718" style="zoom: 80%;" />

**return**

- å®Œæˆ main æ–¹æ³•è°ƒç”¨ï¼Œå¼¹å‡º main æ ˆå¸§
- ç¨‹åºç»“æŸ

### 4. é€šè¿‡å­—èŠ‚ç æŒ‡ä»¤åˆ†æé—®é¢˜

```java
public class MainTest {
    public static void main(String[] args) {
        int a = 10;
        int b = a++ + ++a + a--;
        System.out.println(a);
        System.out.println(b);
    }
}
```

```js
...
Constant pool:
   #1 = Methodref          #5.#22         // java/lang/Object."<init>":()V
   #2 = Fieldref           #23.#24        // java/lang/System.out:Ljava/io/PrintStream;
   #3 = Methodref          #25.#26        // java/io/PrintStream.println:(I)V
   #4 = Class              #27            // org/snbo/MainTest
   #5 = Class              #28            // java/lang/Object
   #6 = Utf8               <init>
   #7 = Utf8               ()V
   #8 = Utf8               Code
   #9 = Utf8               LineNumberTable
  #10 = Utf8               LocalVariableTable
  #11 = Utf8               this
  #12 = Utf8               Lorg/snbo/MainTest;
  #13 = Utf8               main
  #14 = Utf8               ([Ljava/lang/String;)V
  #15 = Utf8               args
  #16 = Utf8               [Ljava/lang/String;
  #17 = Utf8               a
  #18 = Utf8               I
  #19 = Utf8               b
  #20 = Utf8               SourceFile
  #21 = Utf8               MainTest.java
  #22 = NameAndType        #6:#7          // "<init>":()V
  #23 = Class              #29            // java/lang/System
  #24 = NameAndType        #30:#31        // out:Ljava/io/PrintStream;
  #25 = Class              #32            // java/io/PrintStream
  #26 = NameAndType        #33:#34        // println:(I)V
  #27 = Utf8               org/snbo/MainTest
  #28 = Utf8               java/lang/Object
  #29 = Utf8               java/lang/System
  #30 = Utf8               out
  #31 = Utf8               Ljava/io/PrintStream;
  #32 = Utf8               java/io/PrintStream
  #33 = Utf8               println
  #34 = Utf8               (I)V
{
  public org.snbo.MainTest();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 5: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lorg/snbo/MainTest;

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=3, args_size=1
         0: bipush        10        # å°† 10 å…¥æ ˆ
         2: istore_1                # æ ˆé¡¶æ“ä½œæ•° 10 å‡ºæ ˆ,æ”¾å…¥å±€éƒ¨å˜é‡è¡¨ slot 1 ä¸­  -->  int a = 10;
         3: iload_1                 # è¯»å–å±€éƒ¨å˜é‡è¡¨ slot 1 çš„å€¼,å…¥æ ˆ  æ­¤æ—¶æ“ä½œæ•°æ ˆ: [10]
         4: iinc          1, 1      # ç›´æ¥æ›´æ–°å±€éƒ¨å˜é‡åŒºé‡Œçš„å˜é‡,è¿›è¡ŒåŠ  1 æ“ä½œ,ä¸éœ€è¦è¿›è¡Œå…¥æ ˆæ“ä½œ
         7: iinc          1, 1      # åŒä¸Š
        10: iload_1                 # è¯»å–å±€éƒ¨å˜é‡è¡¨ slot 1 çš„å€¼,å…¥æ ˆ, æ­¤æ—¶æ“ä½œæ•°æ ˆ: [12,10]
        11: iadd                    # æ ˆé¡¶æ“ä½œæ•°å‡ºæ ˆç›¸åŠ ,ç»“æœå…¥æ ˆ      æ­¤æ—¶æ“ä½œæ•°æ ˆ: [22]
        12: iload_1                 # è¯»å–å±€éƒ¨å˜é‡è¡¨ slot 1 çš„å€¼,å…¥æ ˆ  æ­¤æ—¶æ“ä½œæ•°æ ˆ: [12,22]
        13: iinc          1, -1     # ç›´æ¥æ›´æ–°å±€éƒ¨å˜é‡åŒºé‡Œçš„å˜é‡,è¿›è¡Œå‡ 1 æ“ä½œ 
        16: iadd                    # æ ˆé¡¶æ ˆé¡¶æ“ä½œæ•°å‡ºæ ˆç›¸åŠ ,ç»“æœå…¥æ ˆ      æ­¤æ—¶æ“ä½œæ•°æ ˆ: [34]
        17: istore_2                # æ ˆé¡¶æ“ä½œæ•°å‡ºæ ˆæ”¾å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 2 ä¸­
        18: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;
        21: iload_1
        line 9: 18
        line 10: 25
        line 11: 32
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      33     0  args   [Ljava/lang/String;
            3      30     1     a   I
           18      15     2     b   I
}

```

åˆ†æï¼š

- æ³¨æ„ **iinc** æŒ‡ä»¤æ˜¯**ç›´æ¥åœ¨å±€éƒ¨å˜é‡ slot ä¸Šè¿›è¡Œè¿ç®—**
- a++ å’Œ ++a çš„åŒºåˆ«æ˜¯å…ˆæ‰§è¡Œ iload è¿˜æ˜¯ å…ˆæ‰§è¡Œ iinc

### 5. æ¡ä»¶åˆ¤æ–­æŒ‡ä»¤

| æŒ‡ä»¤ | åŠ©è®°ç¬¦    | å«ä¹‰             |
| ---- | --------- | ---------------- |
| 0x99 | ifeq      | åˆ¤æ–­æ˜¯å¦ == 0    |
| 0x9a | ifne      | åˆ¤æ–­æ˜¯å¦ != 0    |
| 0x9b | iflt      | åˆ¤æ–­æ˜¯å¦ < 0     |
| 0x9e | ifle      | åˆ¤æ–­æ˜¯å¦ <= 0    |
| 0x9d | ifgt      | åˆ¤æ–­æ˜¯å¦ > 0     |
| 0x9c | ifge      | åˆ¤æ–­æ˜¯å¦ >= 0    |
| 0x9f | if_icmpeq | ä¸¤ä¸ªintæ˜¯å¦ ==   |
| 0xa0 | if_icmpne | ä¸¤ä¸ªintæ˜¯å¦ !=   |
| 0xa1 | if_icmplt | ä¸¤ä¸ªintæ˜¯å¦ <    |
| 0xa4 | if_icmple | ä¸¤ä¸ªintæ˜¯å¦ <=   |
| 0xa3 | if_icmpgt | ä¸¤ä¸ªintæ˜¯å¦ >    |
| 0xa2 | if_icmpge | ä¸¤ä¸ªintæ˜¯å¦ >=   |
| 0xa5 | if_acmpeq | ä¸¤ä¸ªå¼•ç”¨æ˜¯å¦ ==  |
| 0xa6 | if_acmpne | ä¸¤ä¸ªå¼•ç”¨æ˜¯å¦ !=  |
| 0xc6 | ifnull    | åˆ¤æ–­æ˜¯å¦ == null |
| 0xc7 | ifnonnull | åˆ¤æ–­æ˜¯å¦ != null |

å‡ ç‚¹è¯´æ˜ï¼š

- byteï¼Œshortï¼Œchar éƒ½ä¼šæŒ‰ int æ¯”è¾ƒï¼Œå› ä¸ºæ“ä½œæ•°æ ˆéƒ½æ˜¯ 4 å­—èŠ‚

ä¾‹:

```java
public static void main(String[] args) {
        int a = 0;
        if (a == 0) {
            a = 10;
        } else {
            a = 20;
        }
    }
```

å­—èŠ‚ç :

- å½“intå–å€¼**-1~5**æ—¶ï¼ŒJVMé‡‡ç”¨**iconst**æŒ‡ä»¤å°†å¸¸é‡å‹å…¥æ ˆä¸­

```js
         0: iconst_0          # å°† 0 å…¥æ ˆ
         1: istore_1          # æ ˆé¡¶å‡ºæ ˆ,æ”¾å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 1 
         2: iload_1           # è¯»å–å±€éƒ¨å˜é‡è¡¨çš„ slot 1 çš„å€¼,å°†å€¼å…¥æ ˆ
         3: ifne          12  # åˆ¤æ–­æ“ä½œæ•°æ ˆé¡¶çš„å…ƒç´ æ˜¯ä¸æ˜¯ä¸ç­‰äº0,å¦‚æœä¸ç­‰äº,è·³åˆ° 12 è¡Œ
         6: bipush        10  # å°† 10 å…¥æ ˆ(10 < Short.MAX_VALUE å­˜å‚¨åœ¨æ–¹æ³•çš„å­—èŠ‚ç æŒ‡ä»¤é‡Œ) 
         8: istore_1          # æ ˆé¡¶æ“ä½œæ•°å‡ºæ ˆ,æ”¾å…¥å±€éƒ¨å˜é‡è¡¨ slot 1 ä¸­
         9: goto          15  # è·³åˆ° 15 è¡Œ
        12: bipush        20
        14: istore_1
        15: return

```

ä¾‹2:

```java
    public static void main(String[] args) {
        int a = 3;
        if (a == 3) {
            a = 10;
        } else {
            a = 20;
        }
    }
```

```js
         0: iconst_3          # å°† 3 å…¥æ ˆ
         1: istore_1          # å‡ºæ ˆæ”¾å…¥ slot 1
         2: iload_1           # å– slot 1 çš„å€¼å…¥æ ˆ
         3: iconst_3          # å°† 3 å…¥æ ˆ
         4: if_icmpne     13  # æ¯”è¾ƒæ ˆé¡¶ä¸¤ä¸ª int æ•°æ®æ˜¯å¦ä¸ç›¸ç­‰
         7: bipush        10
         9: istore_1
        10: goto          16
        13: bipush        20
        15: istore_1
        16: return

```

### 6.å¾ªç¯æ§åˆ¶æŒ‡ä»¤

```java
    public static void main(String[] args) {
        int a = 0;
        while (a < 5) {
            a++;
        }
    }
```

```js
         0: iconst_0
         1: istore_1
         2: iload_1
         3: iconst_5
         4: if_icmpge     13
         7: iinc          1, 1
        10: goto          2

```

### 7. x = x++

```java
    public static void main(String[] args) {
        int x = 0;
        x = x++; // x çš„å€¼å…ˆæ”¾å…¥æ“ä½œæ•°æ ˆ,ç„¶åå¯¹ slot 1 åŠ  1, æœ€ååˆå°†æ ˆé¡¶å‡ºæ ˆæ”¾å…¥ slot 1 ,æ‰€ä»¥å€¼æ²¡æœ‰å˜
                 // å¦‚æœæ˜¯ ++x , ä¼šå…ˆå¯¹ slot 1 åŠ  1,åœ¨å…¥æ ˆ,å‡ºæ ˆ
        System.out.println(x);
    }
```

```js
         0: iconst_0                         # 0 å…¥æ ˆ                 [0]
         1: istore_1                         # 0 æ”¾å…¥ slot 1          [ ]
         2: iload_1                          # å– slot 1 å€¼å…¥æ ˆ       [0]
         3: iinc          1, 1               # slot 1 è‡ªå¢ 1  æ­¤æ—¶ slot 1 ä¸º 1
         6: istore_1                         # å‡ºæ ˆæ”¾å…¥ slot 1 æ­¤æ—¶ slot 1 ä¸º 0
         7: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;
        10: iload_1
        11: invokevirtual #3                  // Method java/io/PrintStream.println:(I)V
        line 9: 14

```

### 8. æ„é€ æ–¹æ³•

#### 8.1 \<cinit\>()v

- ç¼–è¯‘å™¨ä¼šæŒ‰**ä»ä¸Šè‡³ä¸‹çš„é¡ºåº**ï¼Œæ”¶é›†æ‰€æœ‰ static **é™æ€ä»£ç å—**å’Œ**é™æ€æˆå‘˜èµ‹å€¼**çš„ä»£ç ï¼Œåˆå¹¶ä¸ºä¸€ä¸ªç‰¹æ®Šçš„æ–¹
  æ³• \<cinit\>()V 
- \<cinit\>()V æ–¹æ³•ä¼šåœ¨ç±»åŠ è½½çš„åˆå§‹åŒ–é˜¶æ®µè¢«è°ƒç”¨

```java
public class Demo1 {
    static int i = 10;
    
    static {
        i = 20;
    }
    
    static {
        i = 30;
    }
}

```



```js
	   0: bipush 10
	   2: putstatic #2   // Field i:I
	   5: bipush 20
	   7: putstatic #2   // Field i:I
	   10: bipush 30
	   12: putstatic #2  // Field i:I
	   15: return
```

#### 8.2 \<init\>()v

- ç¼–è¯‘å™¨ä¼šæŒ‰ä»ä¸Šè‡³ä¸‹çš„é¡ºåºï¼Œæ”¶é›†æ‰€æœ‰ **{} ä»£ç å—**å’Œ**æˆå‘˜å˜é‡èµ‹å€¼**çš„ä»£ç ï¼Œå½¢æˆæ–°çš„æ„é€ æ–¹æ³•ï¼Œä½†åŸå§‹æ„é€ æ–¹æ³•å†…çš„ä»£ç æ€»æ˜¯åœ¨æœ€å

```java
public class Demo1 {

    private String a = "s1";

    {
        b = 20; // ç±»çš„æˆå‘˜å˜é‡ä¿¡æ¯ä¼šåŠ è½½åˆ°æ–¹æ³•åŒºä¸­,åŠ è½½åæœ‰æˆå‘˜å˜é‡ b,æ‰€ä»¥è¿è¡Œæ—¶ä¸ä¼šå‡ºé”™,æ­¤å¤„ä¹Ÿä¸ä¼šæŠ¥é”™
    }

    private int b = 10;

    {
        a = "s2";
    }
    
    public Demo1(String a, int b) {
        this.a = a;
        this.b = b;
    }
}

```

å­—èŠ‚ç æ–‡ä»¶:

```js
Code:
stack=2, locals=3, args_size=3
	0: aload_0                            # slot 0 å…¥æ ˆ
	1: invokespecial #1 // super.<init>()V # æ‰§è¡Œçˆ¶ç±»æ„é€ æ–¹æ³•
	4: aload_0                            # slot 0 å…¥æ ˆ
	5: ldc #2 // <- "s1"                    # slot "s1" å…¥æ ˆ (ldc å°†å¸¸é‡æ± ä¸­çš„æŒ‡å®šå†…å®¹å‹æ ˆ)
	7: putfield #3 // -> this.a             # æ ˆé¡¶æ“ä½œæ•°å‡ºæ ˆ,å¹¶å°†å€¼èµ‹ç»™å¯¹è±¡çš„æˆå‘˜å˜é‡ #3
	10: aload_0                           # å°† slot 0 å…¥æ ˆ
	11: bipush 20 // <- 20                  # å°†æ“ä½œæ•° 20 å…¥æ ˆ(æ•°å€¼è¾ƒå°,å’Œæ–¹æ³•çš„å­—èŠ‚ç æŒ‡ä»¤å­˜æ”¾åœ¨ä¸€èµ·)
	13: putfield #4 // -> this.b            # æ ˆé¡¶æ“ä½œæ•°å‡ºæ ˆ,å¹¶å°†å€¼èµ‹ç»™å¯¹è±¡çš„æˆå‘˜å˜é‡ #4
	16: aload_0                           # å°† slot 0 å…¥æ ˆ
	17: bipush 10 // <- 10                  # 10 å…¥æ ˆ
	19: putfield #4 // -> this.b            # æ ˆé¡¶æ“ä½œæ•°å‡ºæ ˆ,å¹¶å°†å€¼èµ‹ç»™å¯¹è±¡çš„æˆå‘˜å˜é‡ #4
	22: aload_0
	23: ldc #5 // <- "s2"
	25: putfield #3 // -> this.a
	28: aload_0 // ------------------------------
	29: aload_1 // <- slot 1(a) "s3" |
	30: putfield #3 // -> this.a |
	33: aload_0 |
	34: iload_2 // <- slot 2(b) 30 |
	35: putfield #4 // -> this.b --------------------
	38: return
```

### 9. æ–¹æ³•è°ƒç”¨

```java
public class Demo3_9 {
   public Demo3_9() { 
   }
   private void test1() {
   }
   private final void test2() { 
   }
   public void test3() {
   }
   public static void test4() { 
   }
    
   public static void main(String[] args) {
       Demo3_9 d = new Demo3_9();
        d.test1();
        d.test2();
        d.test3();
        d.test4();
        Demo3_9.test4();
   }
}
```

å­—èŠ‚ç :

```js
0: new #2 // class cn/itcast/jvm/t3/bytecode/Demo3_9
3: dup
4: invokespecial #3 // Method "<init>":()V
7: astore_1
8: aload_1
9: invokespecial #4 // Method test1:()V
12: aload_1
13: invokespecial #5 // Method test2:()V
16: aload_1
17: invokevirtual #6 // Method test3:()V
20: aload_1
21: pop
22: invokestatic #7 // Method test4:()V
25: invokestatic #7 // Method test4:()V
28: return
```



- new æ˜¯åˆ›å»ºã€å¯¹è±¡ã€‘ï¼Œç»™å¯¹è±¡åˆ†é…å †å†…å­˜ï¼Œæ‰§è¡ŒæˆåŠŸä¼šå°†ã€å¯¹è±¡å¼•ç”¨ã€‘å‹å…¥æ“ä½œæ•°æ ˆ
- dup æ˜¯èµ‹å€¼æ“ä½œæ•°æ ˆæ ˆé¡¶çš„å†…å®¹ï¼Œæœ¬ä¾‹å³ä¸ºã€å¯¹è±¡å¼•ç”¨ã€‘ï¼Œä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä»½å¼•ç”¨å‘¢ï¼Œä¸€ä¸ªæ˜¯è¦é…åˆ invokespecial è°ƒç”¨è¯¥å¯¹è±¡çš„æ„é€ æ–¹æ³• "\<init\>":()V ï¼ˆä¼šæ¶ˆè€—æ‰æ ˆé¡¶ä¸€ä¸ªå¼•ç”¨ï¼‰ï¼Œå¦ä¸€ä¸ªè¦é…åˆ astore_1 èµ‹å€¼ç»™å±€éƒ¨å˜é‡è¡¨ slot 1 ä¸­
- æœ€ç»ˆæ–¹æ³•ï¼ˆfinalï¼‰ï¼Œç§æœ‰æ–¹æ³•ï¼ˆprivateï¼‰ï¼Œæ„é€ æ–¹æ³•éƒ½æ˜¯ç”± invokespecial æŒ‡ä»¤æ¥è°ƒç”¨ï¼Œå±äºé™æ€ç»‘å®š
- æ™®é€šæˆå‘˜æ–¹æ³•æ˜¯ç”± invokevirtual è°ƒç”¨ï¼Œå±äºåŠ¨æ€ç»‘å®šï¼Œå³æ”¯æŒå¤šæ€
- æˆå‘˜æ–¹æ³•ä¸é™æ€æ–¹æ³•è°ƒç”¨çš„å¦ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œæ‰§è¡Œæ–¹æ³•å‰æ˜¯å¦éœ€è¦ã€å¯¹è±¡å¼•ç”¨ã€‘
- æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ d.test4(); æ˜¯é€šè¿‡ã€å¯¹è±¡å¼•ç”¨ã€‘è°ƒç”¨ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨ invokestatic ä¹‹å‰æ‰§è¡Œäº† pop æŒ‡ä»¤ï¼ŒæŠŠã€å¯¹è±¡å¼•ç”¨ã€‘ä»æ“ä½œæ•°æ ˆå¼¹æ‰äº†ğŸ˜‚
- è¿˜æœ‰ä¸€ä¸ªæ‰§è¡Œ invokespecial çš„æƒ…å†µæ˜¯é€šè¿‡ super è°ƒç”¨çˆ¶ç±»æ–¹æ³•

### 10. å¤šæ€åŸç†

å½“æ‰§è¡Œ invokevirtual æŒ‡ä»¤æ—¶ï¼Œ

1. å…ˆé€šè¿‡æ ˆå¸§ä¸­çš„å¯¹è±¡å¼•ç”¨æ‰¾åˆ°å¯¹è±¡
2. åˆ†æå¯¹è±¡å¤´ï¼Œæ‰¾åˆ°å¯¹è±¡çš„å®é™… Class
3. Class ç»“æ„ä¸­æœ‰ vtableï¼Œå®ƒåœ¨ç±»åŠ è½½çš„é“¾æ¥é˜¶æ®µå°±å·²ç»æ ¹æ®æ–¹æ³•çš„é‡å†™è§„åˆ™ç”Ÿæˆå¥½äº†
4. æŸ¥è¡¨å¾—åˆ°æ–¹æ³•çš„å…·ä½“åœ°å€
5. æ‰§è¡Œæ–¹æ³•çš„å­—èŠ‚ç 

### 11. å¼‚å¸¸å¤„ç†

```java
public class Demo3_11_1 {
     public static void main(String[] args) {
         int i = 0;
         try {
             i = 10;
         } catch (Exception e) {
             i = 20;
         }
     }
}
```

```js
public static void main(java.lang.String[]);
descriptor: ([Ljava/lang/String;)V
flags: ACC_PUBLIC, ACC_STATIC
	Code:
	stack=1, locals=3, args_size=1
		0: iconst_0
		1: istore_1
		2: bipush 10
		4: istore_1
		5: goto 12
		8: astore_2
		9: bipush 20
		11: istore_1
		12: return
Exception table:
	from to target type
	   2  5     8   Class java/lang/Exception
LineNumberTable: ...
	LocalVariableTable:
		Start Length Slot Name Signature
		    9     3     2 e      Ljava/lang/Exception;
		    0     13    0 args   [Ljava/lang/String;
		    2     11    1 i      I
StackMapTable: ...
MethodParameters: ...
}
```

- å¯ä»¥çœ‹åˆ°å¤šå‡ºæ¥ä¸€ä¸ª Exception table çš„ç»“æ„ï¼Œ[from, to) æ˜¯å‰é—­åå¼€çš„æ£€æµ‹èŒƒå›´ï¼Œä¸€æ—¦è¿™ä¸ªèŒƒå›´å†…çš„å­—èŠ‚ç æ‰§è¡Œå‡ºç°å¼‚å¸¸ï¼Œåˆ™é€šè¿‡ type åŒ¹é…å¼‚å¸¸ç±»å‹ï¼Œå¦‚æœä¸€è‡´ï¼Œè¿›å…¥ target æ‰€æŒ‡ç¤ºè¡Œå·
- 8 è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ astore_2 æ˜¯å°†å¼‚å¸¸å¯¹è±¡å¼•ç”¨å­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 2 ä½ç½®

- å› ä¸ºå¼‚å¸¸å‡ºç°æ—¶ï¼Œåªèƒ½è¿›å…¥ Exception table ä¸­ä¸€ä¸ªåˆ†æ”¯ï¼Œæ‰€ä»¥å±€éƒ¨å˜é‡è¡¨ slot 2 ä½ç½®ä¼šè¢«å…±ç”¨

#### finally

```java
public class Demo3_11_4 {
    public static void main(String[] args) {
        int i = 0;
        try {
            i = 10;
        } catch (Exception e) {
            i = 20;
        } finally {
            i = 30;
        }
    }
}
```

å­—èŠ‚ç :

```js
public static void main(java.lang.String[]);
        descriptor: ([Ljava/lang/String;)V
        flags: ACC_PUBLIC, ACC_STATIC
        Code:
        stack=1, locals=4, args_size=1
        0: iconst_0
        1: istore_1 		      // 0 -> i
        2: bipush 		10        // try   --------------------------------------
        4: istore_1  		      // 10 -> i                                     |
        5: bipush 		30 		  // finally                                     |
        7: istore_1 		      // 30 -> i                                     |
        8: goto 		27 		 // return -----------------------------------
                      
        11: astore_2 			 // catch Exceptin -> e ----------------------
        12: bipush 		20		 // |
        14: istore_1 		     // 20 -> i |
                      
        15: bipush 		30       // finally |
        17: istore_1 		     // 30 -> i |
        18: goto 		27       // return -----------------------------------
                      
        21: astore_3		     // catch any -> slot 3 ----------------------
        22: bipush 		30       // finally |
        24: istore_1 		     // 30 -> i |
        25: aload_3 		     // <- slot 3 |
        26: athrow 		         // throw ------------------------------------
        27: return
        Exception table:
        from to target type
           2  5     11   Class java/lang/Exception
           2  5     21   any		                  // å‰©ä½™çš„å¼‚å¸¸ç±»å‹ï¼Œæ¯”å¦‚ Error
           11 15    21   any 		              // å‰©ä½™çš„å¼‚å¸¸ç±»å‹ï¼Œæ¯”å¦‚ Error
        LineNumberTable: ...
        LocalVariableTable:
        Start Length Slot Name Signature
        12 3 2 e Ljava/lang/Exception;
        0 28 0 args [Ljava/lang/String;
        2 26 1 i I
        StackMapTable: ...
        MethodParameters: ...
```

- å¯ä»¥çœ‹åˆ° finally ä¸­çš„ä»£ç è¢«å¤åˆ¶äº† 3 ä»½ï¼Œåˆ†åˆ«æ”¾å…¥ try æµç¨‹ï¼Œcatch æµç¨‹ä»¥åŠ catch å‰©ä½™çš„å¼‚å¸¸ç±»å‹æµç¨‹





#### finally å¯¹è¿”å›å€¼å½±å“

æ‰§è¡Œå¦‚ä¸‹ä»£ç æ—¶,

```java
        // è¿”å› 2,æ‰§è¡Œ finally ä»£ç å 2 ç›´æ¥è¢«è¿”å›
        try {
            return 1;
        } finally {
            return 2;
        }

        // è¿”å› 1 ,æ‰§è¡Œ finally ä»£ç ä¹‹å‰, å› ä¸º try é‡Œé¢æ˜¯è¿”å›è¯­å¥,é‡åˆ°è¿”å›è¯­å¥å¹¶ä¸”è¿˜æœ‰ finally æœªæ‰§è¡Œ, è¿”å›å€¼          1 è¢«æš‚å­˜åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­,å¾…æ‰§è¡Œå®Œ finally ä¸­çš„ä»£ç å, ä¼šä»å±€éƒ¨å˜é‡è¡¨ä¸­è¯»å–æš‚å­˜çš„æ•°,å¹¶è¿”å›
        try {
            date = 1;
            return date;
        } finally {
            date = 2;
        }

```

### 12. synchronized

```java
 public class Demo3_13 {
        public static void main(String[] args) {
            Object lock = new Object();
            synchronized (lock) {
                System.out.println("ok");
            }
       }
 }
```

å­—èŠ‚ç :

```js
public static void main(java.lang.String[]);
        descriptor: ([Ljava/lang/String;)V
        flags: ACC_PUBLIC, ACC_STATIC
        Code:
        stack=2, locals=4, args_size=1
        0: new #2             	// new Object
        3: dup
        4: invokespecial #1   	// invokespecial <init>:()V
        7: astore_1           	// lockå¼•ç”¨ -> lock
        8: aload_1 			 	// <- lock ï¼ˆsynchronizedå¼€å§‹ï¼‰
        9: dup                   // å¤åˆ¶ä¸€ä»½å¼•ç”¨
        10: astore_2 		 	// lockå¼•ç”¨ -> slot 2
        11: monitorenter 	 	// monitorenter(lockå¼•ç”¨)
        12: getstatic #3 	 	// <- System.out
        15: ldc #4 				// <- "ok"
        17: invokevirtual #5 	// invokevirtual println:(Ljava/lang/String;)V
        20: aload_2 			// <- slot 2(lockå¼•ç”¨)
        21: monitorexit 		// monitorexit(lockå¼•ç”¨)
        22: goto 30
        25: astore_3 			// any -> slot 3
        26: aload_2 			// <- slot 2(lockå¼•ç”¨)
        27: monitorexit 		// monitorexit(lockå¼•ç”¨)
        28: aload_3
        29: athrow
        30: return
        Exception table:
           from to target type
             12  22   25   any // å‘ç”Ÿå¼‚å¸¸è·³åˆ° 25 è¡Œ -> è§£é”
             25  28   25   any // è§£é”è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸é‡æ–°åˆ° 25 è¡Œ,é‡æ–°è§£é”
        LineNumberTable: ...
        LocalVariableTable:
        Start Length Slot Name Signature
        0 31 0 args [Ljava/lang/String;
        8 23 1 lock Ljava/lang/Object;
        StackMapTable: ...
        MethodParameters: ...
```

- æ³¨: æ–¹æ³•çº§åˆ«çš„ synchronized ä¸ä¼šåœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­æœ‰æ‰€ä½“ç°



## 2.ç¼–è¯‘æœŸå¤„ç†-è¯­æ³•ç³–

**ç¼–è¯‘æœŸå¯¹å­—èŠ‚ç çš„ä¼˜åŒ–å’Œå¤„ç†ç§°ä¹‹ä¸ºè¯­æ³•ç³–** 

- æ‰€è°“çš„ è¯­æ³•ç³–ï¼Œå…¶å®å°±æ˜¯æŒ‡ java ç¼–è¯‘å™¨æŠŠ *.java æºç ç¼–è¯‘ä¸º *.class å­—èŠ‚ç çš„è¿‡ç¨‹ä¸­ï¼Œè‡ªåŠ¨ç”Ÿæˆå’Œè½¬æ¢çš„ä¸€äº›ä»£ç ï¼Œä¸»è¦æ˜¯ä¸ºäº†å‡è½»ç¨‹åºå‘˜çš„è´Ÿæ‹…ï¼Œç®—æ˜¯ java ç¼–è¯‘å™¨ç»™æˆ‘ä»¬çš„ä¸€ä¸ªé¢å¤–ç¦åˆ©ï¼ˆç»™ç³–åƒå˜›ï¼‰

- æ³¨æ„ï¼Œä»¥ä¸‹ä»£ç çš„åˆ†æï¼Œå€ŸåŠ©äº† javap å·¥å…·ï¼Œidea çš„åç¼–è¯‘åŠŸèƒ½ï¼Œidea æ’ä»¶ jclasslib ç­‰å·¥å…·ã€‚å¦å¤–ï¼Œç¼–è¯‘å™¨è½¬æ¢çš„ç»“æœç›´æ¥å°±æ˜¯ class å­—èŠ‚ç ï¼Œåªæ˜¯ä¸ºäº†ä¾¿äºé˜…è¯»ï¼Œç»™å‡ºäº†å‡ ä¹ç­‰ä»· çš„ java æºç æ–¹å¼ï¼Œå¹¶ä¸æ˜¯ç¼–è¯‘å™¨è¿˜ä¼šè½¬æ¢å‡ºä¸­é—´çš„ java æºç ï¼Œåˆ‡è®°ã€‚

### 2.1 é»˜è®¤æ„é€ å™¨

```java
public class Demo{

}
```

idea è½¬æ¢å­—èŠ‚ç :

```java
public class Demo {
    // è¿™ä¸ªæ— å‚æ„é€ æ˜¯ç¼–è¯‘å™¨å¸®åŠ©æˆ‘ä»¬åŠ ä¸Šçš„
    public Demo() {
        super(); // å³è°ƒç”¨çˆ¶ç±» Object çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œå³è°ƒç”¨ java/lang/Object."<init>":()V
    }
}
```

### 2.2 è‡ªåŠ¨æ‹†è£…ç®±

è¿™ä¸ªç‰¹æ€§æ˜¯ JDK 5 å¼€å§‹åŠ å…¥çš„ï¼Œ ä»£ç ç‰‡æ®µ1 ï¼š

```java
    public class Candy2 {
        public static void main(String[] args) {
            Integer x = Integer.valueOf(1);
            int y = x.intValue();
        }
    }
```

è¿™æ®µä»£ç åœ¨ JDK 5 ä¹‹å‰æ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡çš„ï¼Œå¿…é¡»æ”¹å†™ä¸º ä»£ç ç‰‡æ®µ2 :

```java
    public class Candy2 {
        public static void main(String[] args) {
            Integer x = Integer.valueOf(1);
            int y = x.intValue();
        }
    }
```

æ˜¾ç„¶ä¹‹å‰ç‰ˆæœ¬çš„ä»£ç å¤ªéº»çƒ¦äº†ï¼Œéœ€è¦åœ¨åŸºæœ¬ç±»å‹å’ŒåŒ…è£…ç±»å‹ä¹‹é—´æ¥å›è½¬æ¢ï¼ˆå°¤å…¶æ˜¯é›†åˆç±»ä¸­æ“ä½œçš„éƒ½æ˜¯
åŒ…è£…ç±»å‹ï¼‰ï¼Œå› æ­¤è¿™äº›è½¬æ¢çš„äº‹æƒ…åœ¨ JDK 5 ä»¥åéƒ½ç”±ç¼–è¯‘å™¨åœ¨ç¼–è¯‘é˜¶æ®µå®Œæˆã€‚**å³ ä»£ç ç‰‡æ®µ1 éƒ½ä¼šåœ¨ç¼–**
**è¯‘é˜¶æ®µè¢«è½¬æ¢ä¸º ä»£ç ç‰‡æ®µ2**

### 2.3 æ³›å‹æ“¦é™¤

æ³›å‹ä¹Ÿæ˜¯åœ¨ JDK 5 å¼€å§‹åŠ å…¥çš„ç‰¹æ€§ï¼Œä½† java åœ¨ç¼–è¯‘æ³›å‹ä»£ç åä¼šæ‰§è¡Œ æ³›å‹æ“¦é™¤ çš„åŠ¨ä½œï¼Œå³æ³›å‹ä¿¡æ¯
åœ¨ç¼–è¯‘ä¸ºå­—èŠ‚ç ä¹‹åå°±ä¸¢å¤±äº†ï¼Œå®é™…çš„ç±»å‹éƒ½å½“åšäº† Object ç±»å‹æ¥å¤„ç†ï¼š

```java
    public class Candy3 {
        public static void main(String[] args) {
            List<Integer> list = new ArrayList<>();
            list.add(10); // å®é™…è°ƒç”¨çš„æ˜¯ List.add(Object e)
            Integer x = list.get(0); // å®é™…è°ƒç”¨çš„æ˜¯ Object obj = List.get(int index);
        }
    }
```

æ‰€ä»¥åœ¨å–å€¼æ—¶ï¼Œç¼–è¯‘å™¨çœŸæ­£ç”Ÿæˆçš„å­—èŠ‚ç ä¸­ï¼Œè¿˜è¦é¢å¤–åšä¸€ä¸ªç±»å‹è½¬æ¢çš„æ“ä½œï¼š

```java
// éœ€è¦å°† Object è½¬ä¸º Integer
Integer x = (Integer)list.get(0);
```

å¦‚æœå‰é¢çš„ x å˜é‡ç±»å‹ä¿®æ”¹ä¸º int åŸºæœ¬ç±»å‹é‚£ä¹ˆæœ€ç»ˆç”Ÿæˆçš„å­—èŠ‚ç æ˜¯ï¼š

```java
// éœ€è¦å°† Object è½¬ä¸º Integer, å¹¶æ‰§è¡Œæ‹†ç®±æ“ä½œ
int x = ((Integer)list.get(0)).intValue();
```

æ“¦é™¤çš„æ˜¯å­—èŠ‚ç ä¸Šçš„æ³›å‹ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ° LocalVariableTypeTable ä»ç„¶ä¿ç•™äº†æ–¹æ³•å‚æ•°æ³›å‹çš„ä¿¡æ¯

```js
public cn.itcast.jvm.t3.candy.Candy3();
        descriptor: ()V
        flags: ACC_PUBLIC
        Code:
        stack=1, locals=1, args_size=1
        0: aload_0
        1: invokespecial #1 // Method java/lang/Object."<init>":()V
        4: return
        LineNumberTable:
        line 6: 0
        LocalVariableTable:
        Start Length Slot Name Signature
        0 5 0 this Lcn/itcast/jvm/t3/candy/Candy3;
public static void main(java.lang.String[]);
        descriptor: ([Ljava/lang/String;)V
        flags: ACC_PUBLIC, ACC_STATIC
        Code:
        stack=2, locals=3, args_size=1
        0: new #2 // class java/util/ArrayList
        3: dup
        4: invokespecial #3 // Method java/util/ArrayList."<init>":()V
        7: astore_1
        8: aload_1
        9: bipush 10
        11: invokestatic #4 // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;
        14: invokeinterface #5, 2 // InterfaceMethod java/util/List.add:(Ljava/lang/Object;)Z
        19: pop
        20: aload_1
        21: iconst_0
        22: invokeinterface #6, 2 // InterfaceMethod java/util/List.get:(I)Ljava/lang/Object;
        27: checkcast #7 // class java/lang/Integer è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢æ“ä½œ
        30: astore_2
        31: return

        LineNumberTable:
        line 8: 0
        line 9: 8
        line 10: 20
        line 11: 31
        LocalVariableTable: //å±€éƒ¨å˜é‡ç±»å‹è¡¨,åŒ…å«äº†æ–¹æ³•çš„æ³›å‹ä¿¡æ¯
        Start Length Slot Name Signature
            8     24    1 list    Ljava/util/List<Ljava/lang/Integer;>;
```

è™½ç„¶ä¿ç•™äº†æ³›å‹ä¿¡æ¯,ä½†æ˜¯å±€éƒ¨å˜é‡çš„æ³›å‹ä¿¡æ¯æ˜¯æ— æ³•é€šè¿‡åå°„è·å¾—çš„,ä½¿ç”¨åå°„ï¼Œä»ç„¶èƒ½å¤Ÿè·å¾—è¿™äº›ä¿¡æ¯(æ–¹æ³•å‚æ•°å’Œè¿”å›å€¼çš„æ³›å‹ä¿¡æ¯)ï¼š

```java
public Set<Integer> test(List<String> list, Map<Integer, Object> map) {
}
```

```java
   public static void main(String[] args) {
        Method test = Candy3.class.getMethod("test", List.class, Map.class);
        Type[] types = test.getGenericParameterTypes();
        for (Type type : types) {
            // åˆ¤æ–­æ˜¯ä¸æ˜¯æ³›å‹å‚æ•°
            if (type instanceof ParameterizedType) {
                // è½¬æ¢ä¸ºæ³›å‹ç±»å‹ç±»
                ParameterizedType parameterizedType = (ParameterizedType) type;
                System.out.println("åŸå§‹ç±»å‹ - " + parameterizedType.getRawType());
                //è·å–æ³›å‹å¯¹è±¡çš„æ³›å‹
                Type[] arguments = parameterizedType.getActualTypeArguments();
                for (int i = 0; i < arguments.length; i++) {
                    System.out.printf("æ³›å‹å‚æ•°[%d] - %s\n", i, arguments[i]);
                }
            }
        }
    }
```

æ€»ç»“: æ³›å‹æ“¦é™¤å³å½“ç¼–è¯‘ä¸ºå­—èŠ‚ç ä¿¡æ¯åæ³›å‹è¢«æ¶ˆé™¤,æ‰€æœ‰ç±»å‹éƒ½**å½“åš Object ç±»å¤„ç†**, æœ‰å–å€¼æ“ä½œæ—¶,ç¼–è¯‘å™¨ç¼–è¯‘æ—¶ä¼šåŠ ä¸Šå¼ºåˆ¶è½¬æ¢æ“ä½œ,ä½†åœ¨æ³›å‹æ“¦é™¤æ—¶**å¹¶ä¸ä¼šå°†æ‰€æœ‰çš„æ³›å‹ç±»å‹éƒ½æ“¦é™¤æ‰**,å®ƒåªä¼š**æ“¦é™¤è¿è¡Œæ—¶çš„æ³›å‹ç±»å‹**ï¼Œç¼–è¯‘æ—¶ç±»ä¸­å®šä¹‰çš„æ³›å‹ç±»å‹æ˜¯ä¸ä¼šè¢«æ“¦é™¤çš„ï¼Œå¯¹åº”çš„æ³›å‹ç±»å‹ä¼šè¢«ä¿å­˜åœ¨Signatureä¸­(ä½†å±€éƒ¨å˜é‡çš„æ³›å‹ä¿¡æ¯ä¸èƒ½é€šè¿‡åå°„è·å¾—)ã€‚

### 2.4 å¯å˜å‚æ•°

å¯å˜å‚æ•°ä¹Ÿæ˜¯ JDK 5 å¼€å§‹åŠ å…¥çš„æ–°ç‰¹æ€§ï¼š
ä¾‹å¦‚ï¼š

```java
    public class Candy4 {
        public static void foo(String... args) {
            String[] array = args; // ç›´æ¥èµ‹å€¼
            System.out.println(array);
        }

        public static void main(String[] args) {
            foo("hello", "world");
        }
    }
```

å¯å˜å‚æ•° String... args å…¶å®æ˜¯ä¸€ä¸ª String[] args ï¼Œä»ä»£ç ä¸­çš„èµ‹å€¼è¯­å¥ä¸­å°±å¯ä»¥çœ‹å‡ºæ¥ã€‚
åŒæ · java ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æœŸé—´å°†ä¸Šè¿°ä»£ç å˜æ¢ä¸ºï¼š

```java
    public class Candy4 {
        public static void foo(String[] args) {
            String[] array = args; // ç›´æ¥èµ‹å€¼
            System.out.println(array);
        }
        public static void main(String[] args) {
            foo(new String[]{"hello", "world"});
        }
    }
```

æ³¨ : å¦‚æœè°ƒç”¨äº† foo() åˆ™ç­‰ä»·ä»£ç ä¸º foo(new String[]{}) ï¼Œåˆ›å»ºäº†ä¸€ä¸ªç©ºçš„æ•°ç»„ï¼Œè€Œä¸ä¼šä¼ é€’
null è¿›å»

### 2.5 å¢å¼º for å¾ªç¯

- æ•°ç»„åº•å±‚æ˜¯æ™®é€šforå¾ªç¯ï¼›é›†åˆåº•å±‚forå¢å¼ºæ˜¯è¿­ä»£å™¨

### 2.6 switch å­—ç¬¦ä¸²

ä» JDK 7 å¼€å§‹ï¼Œswitch å¯ä»¥ä½œç”¨äºå­—ç¬¦ä¸²å’Œæšä¸¾ç±»ï¼Œè¿™ä¸ªåŠŸèƒ½å…¶å®ä¹Ÿæ˜¯è¯­æ³•ç³–ï¼Œä¾‹å¦‚ï¼š

```java
    public class Candy6_1 {
        public static void choose(String str) {
            switch (str) {
                case "hello": {
                    System.out.println("h");
                    break;
                }
                case "world": {
                    System.out.println("w");
                    break;
                }
            }
        }
    }
```

- æ³¨: switch é…åˆ String å’Œæšä¸¾ä½¿ç”¨æ—¶ï¼Œ**å˜é‡ä¸èƒ½ä¸ºnull**ï¼ŒåŸå› åˆ†æå®Œè¯­æ³•ç³–è½¬æ¢åçš„ä»£ç åº”å½“è‡ªç„¶æ¸…æ¥š

å­—èŠ‚ç è½¬æ¢: 

```java
            public static void choose(String str) {
                byte x = -1;
                
                switch(str.hashCode()) {
                    case 99162322: // hello çš„ hashCode, åŸºæœ¬æ•°æ®ç±»å‹
                        if (str.equals("hello")) {
                            x = 0;
                        }
                        break;
                    case 113318802: // world çš„ hashCode
                        if (str.equals("world")) {
                            x = 1;
                        }
                }
                // ä¸¤ä¸ª switch è§£è€¦
                switch(x) {
                    case 0:
                        System.out.println("h");
                        break;
                    case 1:
                        System.out.println("w");
                }
            }
```

### 2.7 æšä¸¾ç±»

JDK 7 æ–°å¢äº†æšä¸¾ç±»ï¼Œä»¥å‰é¢çš„æ€§åˆ«æšä¸¾ä¸ºä¾‹ï¼š

```java
enum Sex {
   MALE, FEMALE
}
```

å­—èŠ‚ç è½¬æ¢:

```java
 public final class Sex extends Enum<Sex> {
        public static final Sex MALE;
        public static final Sex FEMALE;
        private static final Sex[] $VALUES;

        static {
            MALE = new Sex("MALE", 0);
            FEMALE = new Sex("FEMALE", 1);
            $VALUES = new Sex[]{MALE, FEMALE};
        }

        private Sex(String name, int ordinal) {
            super(name, ordinal);
        }
     
        public static Sex[] values() {
            return $VALUES.clone();
        }
     
        public static Sex valueOf(String name) {
            return Enum.valueOf(Sex.class, name);
        }
    }
```

### 2.8 try-with-resources

JDK 7 å¼€å§‹æ–°å¢äº†å¯¹éœ€è¦å…³é—­çš„èµ„æºå¤„ç†çš„ç‰¹æ®Šè¯­æ³•try-with-resources`ï¼š

```java
try(èµ„æºå˜é‡ = åˆ›å»ºèµ„æºå¯¹è±¡){

} catch( ) {

}
```

å…¶ä¸­èµ„æºå¯¹è±¡éœ€è¦å®ç° AutoCloseable æ¥å£ï¼Œä¾‹å¦‚ InputStream ã€OutputStream ã€
Connection ã€Statement ã€ResultSet ç­‰æ¥å£éƒ½å®ç°äº† AutoCloseable ï¼Œä½¿ç”¨ try-with-resources
å¯ä»¥ä¸ç”¨å†™ finally è¯­å¥å—ï¼Œç¼–è¯‘å™¨ä¼šå¸®åŠ©ç”Ÿæˆå…³é—­èµ„æºä»£ç ï¼Œä¾‹å¦‚ï¼š

```java
public class Candy9 {
	public static void main(String[] args) {
		try(InputStream is = new FileInputStream("d:\\1.txt")) {
			System.out.println(is);
		} catch (IOException e) {
			e.printStackTrace();
		}
	}
}
```

å­—èŠ‚ç è½¬æ¢:

```java
    public static void main(String[] args) {
        try {
            InputStream is = new FileInputStream("d:\\1.txt");
            Throwable t = null;
            try {
                System.out.println(is);
            } catch (Throwable e1) {
                // t æ˜¯æˆ‘ä»¬ä»£ç å‡ºç°çš„å¼‚å¸¸
                t = e1;
                throw e1;
            } finally {
                // åˆ¤æ–­äº†èµ„æºä¸ä¸ºç©º
                if (is != null) {
                    // å¦‚æœæˆ‘ä»¬ä»£ç æœ‰å¼‚å¸¸
                    if (t != null) {
                        try {
                            is.close();
                        } catch (Throwable e2) {
                            // å¦‚æœ close å‡ºç°å¼‚å¸¸ï¼Œä½œä¸ºè¢«å‹åˆ¶å¼‚å¸¸æ·»åŠ 
                            // ä¸¤ä¸ªå¼‚å¸¸ä¿¡æ¯éƒ½ä¼šè¢«æŠ›å‡º,ä¸ä¼šä¸¢å¤±
                            t.addSuppressed(e2);
                        }
                    } else {
                        // å¦‚æœæˆ‘ä»¬ä»£ç æ²¡æœ‰å¼‚å¸¸ï¼Œclose å‡ºç°çš„å¼‚å¸¸å°±æ˜¯æœ€å catch å—ä¸­çš„ e
                        is.close();
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
```

### 2.9 æ–¹æ³•é‡å†™æ—¶çš„æ¡¥æ¥æ–¹æ³•

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ–¹æ³•é‡å†™æ—¶å¯¹è¿”å›å€¼åˆ†ä¸¤ç§æƒ…å†µï¼š

- çˆ¶å­ç±»çš„è¿”å›å€¼å®Œå…¨ä¸€è‡´
- å­ç±»è¿”å›å€¼å¯ä»¥æ˜¯çˆ¶ç±»è¿”å›å€¼çš„å­ç±»ï¼ˆæ¯”è¾ƒç»•å£ï¼Œè§ä¸‹é¢çš„ä¾‹å­ï¼‰

```java
class A {
    public Number m() {
        return 1;
    }
}
class B extends A {
    @Override
    // å­ç±» m æ–¹æ³•çš„è¿”å›å€¼æ˜¯ Integer æ˜¯çˆ¶ç±» m æ–¹æ³•è¿”å›å€¼ Number çš„å­ç±»
    public Integer m() {
        return 2;
    }
}
```

å­—èŠ‚ç è½¬æ¢:

```java
class B extends A {
    public Integer m() {
        return 2;
    }
    // æ­¤æ–¹æ³•æ‰æ˜¯çœŸæ­£é‡å†™äº†çˆ¶ç±» public Number m() æ–¹æ³•
    public synthetic bridge Number m() {
        // è°ƒç”¨ public Integer m()
        return m();
    }
}
```

å…¶ä¸­æ¡¥æ¥æ–¹æ³•æ¯”è¾ƒç‰¹æ®Šï¼Œä»…å¯¹ java è™šæ‹Ÿæœºå¯è§ï¼Œå¹¶ä¸”ä¸åŸæ¥çš„ public Integer m() æ²¡æœ‰å‘½åå†²çª.



### 2.10 åŒ¿åå†…éƒ¨ç±»

æºä»£ç ï¼š

```java
    public class Candy11 {
        public static void main(String[] args) {
            Runnable runnable = new Runnable() {
                @Override
                public void run() {
                    System.out.println("ok");
                }
            };
        }
    }
```

å­—èŠ‚ç è½¬æ¢:

```java
    // é¢å¤–ç”Ÿæˆçš„ç±»
    final class Candy11$1 implements Runnable {
        Candy11$1() {
        }
        public void run() {
            System.out.println("ok");
        }
    }

	public class Candy11 {
		public static void main(String[] args) {
			Runnable runnable = new Candy11$1();
		}
	}
```



å¼•ç”¨å±€éƒ¨å˜é‡çš„åŒ¿åå†…éƒ¨ç±»ï¼Œæºä»£ç ï¼š

```java
    public class Candy11 {
        public static void test(final int x) {
            Runnable runnable = new Runnable() {
                @Override
                public void run() {
                    System.out.println("ok:" + x);
                }
            };
        }
    }
```

å­—èŠ‚ç è½¬æ¢:

```java
    // é¢å¤–ç”Ÿæˆçš„ç±»
    final class Candy11$1 implements Runnable {
        int val$x;
        Candy11$1(int x) {
            this.val$x = x;
        }
        public void run() {
            System.out.println("ok:" + this.val$x);
        }
    }
    
    public class Candy11 {
        public static void test(final int x) {
            Runnable runnable = new Candy11$1(x);
        }
    }
```

æ³¨æ„: è¿™åŒæ—¶è§£é‡Šäº†ä¸ºä»€ä¹ˆåŒ¿åå†…éƒ¨ç±»å¼•ç”¨å±€éƒ¨å˜é‡æ—¶ï¼Œ**å±€éƒ¨å˜é‡å¿…é¡»æ˜¯ final çš„**ï¼šå› ä¸ºåœ¨**åˆ›å»º**
**Candy11$1 å¯¹è±¡æ—¶ï¼Œå°† x çš„å€¼èµ‹å€¼ç»™äº† Candy11$1 å¯¹è±¡çš„ val$x å±æ€§**ï¼Œæ‰€ä»¥ x ä¸åº”è¯¥å†å‘ç”Ÿå˜
åŒ–äº†ï¼Œå¦‚æœå˜åŒ–ï¼Œé‚£ä¹ˆ val$x å±æ€§æ²¡æœ‰æœºä¼šå†è·Ÿç€ä¸€èµ·å˜åŒ–



## 3.ç±»åŠ è½½é˜¶æ®µ

![image-20220822193608849](D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220822193608849.png)

### 3.1 åŠ è½½(ç‹­ä¹‰ä¸Šçš„åŠ è½½)

#### åŠ è½½çš„ç†è§£

- æ‰€è°“åŠ è½½ï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯**å°†Javaç±»çš„å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°æœºå™¨å†…å­˜ä¸­ï¼Œå¹¶åœ¨å†…å­˜ä¸­æ„å»ºå‡ºJavaç±»çš„åŸå‹ - ç±»æ¨¡æ¿å¯¹è±¡**ã€‚æ‰€è°“ç±»æ¨¡æ¿å¯¹è±¡ï¼Œå…¶å®å°±æ˜¯ Java ç±»åœ¨ JVM å†…å­˜ä¸­çš„ä¸€ä¸ªå¿«ç…§ï¼ŒJVM å°†ä»å­—èŠ‚ç æ–‡ä»¶ä¸­è§£æå‡ºçš„å¸¸é‡æ± ã€ç±»å­—æ®µã€ç±»æ–¹æ³•ç­‰ä¿¡æ¯å­˜å‚¨åˆ°ç±»æ¨¡æ¿ä¸­ï¼Œè¿™æ · JVM åœ¨è¿è¡ŒæœŸä¾¿èƒ½é€šè¿‡ç±»æ¨¡æ¿è€Œè·å– Java ç±»ä¸­çš„ä»»æ„ä¿¡æ¯ï¼Œèƒ½å¤Ÿå¯¹Javaç±»çš„æˆå‘˜å˜é‡è¿›è¡Œéå†ï¼Œä¹Ÿèƒ½è¿›è¡ŒJavaæ–¹æ³•çš„è°ƒç”¨ã€‚
- åå°„çš„æœºåˆ¶å³åŸºäºè¿™ä¸€åŸºç¡€ã€‚ å¦‚æœ JVM æ²¡æœ‰å°† Java ç±»çš„å£°æ˜ä¿¡æ¯å­˜å‚¨èµ·æ¥ï¼Œåˆ™ JVM åœ¨è¿è¡ŒæœŸä¹Ÿæ— æ³•åå°„ã€‚

#### åŠ è½½å®Œæˆçš„æ“ä½œ

åŠ è½½é˜¶æ®µï¼Œç®€è¨€ä¹‹ï¼Œ**æŸ¥æ‰¾å¹¶åŠ è½½ç±»çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œç”ŸæˆClassçš„å®ä¾‹ã€‚**åœ¨åŠ è½½ç±»æ—¶ï¼ŒJava è™šæ‹Ÿæœºå¿…é¡»å®Œæˆä»¥ä¸‹3ä»¶äº‹æƒ…:

- é€šè¿‡ç±»çš„å…¨åï¼Œè·å–ç±»çš„äºŒè¿›åˆ¶æ•°æ®æµã€‚
- å°†ç±»çš„äºŒè¿›åˆ¶æ•°æ®æµè§£æä¸ºæ–¹æ³•åŒºå†…çš„æ•°æ®ç»“æ„( Java ç±»æ¨¡å‹)
- åˆ›å»º java.lang.Class ç±»çš„å®ä¾‹ï¼Œè¡¨ç¤ºè¯¥ç±»å‹ã€‚ä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£

##### äºŒè¿›åˆ¶æµçš„è·å–æ–¹å¼

(åªè¦äºŒè¿›åˆ¶æ•°æ®æ—¶ç¬¦åˆå­—èŠ‚ç è§„èŒƒ)

- **è™šæ‹Ÿæœºé€šè¿‡æ–‡ä»¶ç³»ç»Ÿè¯»å…¥ä¸€ä¸ª class åç¼€çš„æ–‡ä»¶**
- **è¯»å…¥ jar,zip ç­‰å½’æ¡£æ•°æ®åŒ…,æå–ç±»æ–‡ä»¶**
- ç½‘ç»œåŠ è½½ç­‰

è·å–åˆ°ç±»çš„äºŒè¿›åˆ¶ä¿¡æ¯å, Java è™šæ‹Ÿæœºå°±ä¼šå¤„ç†è¿™äº›æ•°æ®,å¹¶æœ€ç»ˆè½¬æ¢ä¸ºä¸€ä¸ª java.lang.Class çš„å®ä¾‹

##### ç±»æ¨¡å‹ä½ç½®

æ–¹æ³•åŒº(1.8 ä¹‹å‰åœ¨æ°¸ä¹…ä»£, 1.8 ä¹‹ååœ¨å…ƒç©ºé—´(æœ¬åœ°å†…å­˜))

##### Classå®ä¾‹çš„ä½ç½®

ç±»å°† .class æ–‡ä»¶åŠ è½½è‡³å…ƒç©ºé—´åï¼Œä¼šåœ¨å †ä¸­åˆ›å»ºä¸€ä¸ª Java.lang.Class å¯¹è±¡ï¼Œç”¨æ¥å°è£…ç±»ä½äºæ–¹æ³•åŒºå†…çš„æ•°æ®ç»“æ„ï¼Œè¯¥ Class å¯¹è±¡æ˜¯åœ¨åŠ è½½ç±»çš„è¿‡ç¨‹ä¸­åˆ›å»ºçš„ï¼Œæ¯ä¸ªç±»éƒ½å¯¹åº”æœ‰ä¸€ä¸ª Class ç±»å‹çš„å¯¹è±¡ã€‚

å¦‚å›¾:

<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220822202650531.png" alt="image-20220822202650531" style="zoom:50%;" />

- å¤–éƒ¨å¯ä»¥é€šè¿‡è®¿é—®ä»£è¡¨ 0rder ç±»çš„ Class å¯¹è±¡æ¥è·å– Order çš„ç±»æ•°æ®ç»“æ„ã€‚

<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220822203956367.png" alt="image-20220822203956367" style="zoom:50%;" />

Class å¯¹è±¡è°ƒç”¨ getField() ç­‰æ–¹æ³•æ—¶,å®é™…æ˜¯ä»æ–¹æ³•åŒºä¸­è·å–

### 3.2 é“¾æ¥

#### 1) éªŒè¯

éªŒè¯ç±»æ˜¯å¦ç¬¦åˆ JVMè§„èŒƒï¼Œå®‰å…¨æ€§æ£€æŸ¥

#### 2) å‡†å¤‡

ä¸º static **å˜é‡**åˆ†é…ç©ºé—´ï¼Œè®¾ç½®é»˜è®¤å€¼(é™æ€å˜é‡è·Ÿéš Class å¯¹è±¡,å­˜å‚¨åœ¨å †ä¸­)

- static å˜é‡åœ¨ JDK 7 ä¹‹å‰å­˜å‚¨äº instanceKlass æœ«å°¾ï¼Œä» JDK 7 å¼€å§‹ï¼Œå­˜å‚¨äº _java_mirror æœ«å°¾
- static å˜é‡åˆ†é…ç©ºé—´å’Œèµ‹å€¼æ˜¯ä¸¤ä¸ªæ­¥éª¤ï¼Œåˆ†é…ç©ºé—´åœ¨å‡†å¤‡é˜¶æ®µå®Œæˆï¼Œèµ‹å€¼åœ¨åˆå§‹åŒ–é˜¶æ®µå®Œæˆ
- å¦‚æœ **static final çš„åŸºæœ¬ç±»å‹(é™æ€å¸¸é‡)**ï¼Œä»¥åŠ **é™æ€å­—ç¬¦ä¸²å¸¸é‡**ï¼Œé‚£ä¹ˆç¼–è¯‘é˜¶æ®µå€¼å°±ç¡®å®šäº†ï¼Œèµ‹å€¼åœ¨å‡†å¤‡é˜¶æ®µå®Œæˆ,å¦‚æœ static final çš„å¼•ç”¨ç±»å‹ï¼Œé‚£ä¹ˆèµ‹å€¼ä¹Ÿä¼šåœ¨åˆå§‹åŒ–é˜¶æ®µå®Œæˆ

#### 3) è§£æ

å°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨è§£æä¸ºç›´æ¥å¼•ç”¨

ä¹Ÿå°±æ˜¯å¾—åˆ°ç±»ã€å­—æ®µã€æ–¹æ³•åœ¨å†…å­˜ä¸­çš„æŒ‡é’ˆæˆ–è€…åç§»é‡ã€‚å› æ­¤ï¼Œå¯ä»¥è¯´ï¼Œå¦‚æœç›´æ¥å¼•ç”¨å­˜åœ¨ï¼Œé‚£ä¹ˆå¯ä»¥è‚¯å®šç³»ç»Ÿä¸­å­˜åœ¨è¯¥ç±»ã€æ–¹æ³•æˆ–è€…å­—æ®µã€‚ä½†åªå­˜åœ¨ç¬¦å·å¼•ç”¨ï¼Œä¸èƒ½ç¡®å®šç³»ç»Ÿä¸­ä¸€å®šå­˜åœ¨è¯¥ç»“æ„ã€‚

### 3.3 åˆå§‹åŒ–

#### 1) åˆå§‹åŒ–è¿‡ç¨‹

ç±»çš„åˆå§‹åŒ–æ˜¯ç±»è£…è½½çš„æœ€åä¸€ä¸ªé˜¶æ®µã€‚å¦‚æœå‰é¢çš„æ­¥éª¤éƒ½æ²¡æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆè¡¨ç¤ºç±»å¯ä»¥é¡ºåˆ©è£…è½½åˆ°ç³»ç»Ÿä¸­ã€‚æ­¤æ—¶ï¼Œç±»æ‰ä¼šå¼€å§‹æ‰§è¡ŒJavaå­—èŠ‚ç ã€‚(å³: **åˆ°äº†åˆå§‹åŒ–é˜¶æ®µï¼Œæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œç±»ä¸­å®šä¹‰çš„ Java ç¨‹åºä»£ç **ã€‚)

åˆå§‹åŒ–é˜¶æ®µçš„é‡è¦å·¥ä½œæ˜¯æ‰§è¡Œç±»çš„åˆå§‹åŒ–æ–¹æ³•: <clinit>() æ–¹æ³•

- è¯¥æ–¹æ³•**ä»…èƒ½ç”± Java ç¼–è¯‘å™¨ç”Ÿæˆå¹¶ç”± JVM è°ƒç”¨**ï¼Œç¨‹åºå¼€å‘è€…æ— æ³•è‡ªå®šä¹‰ä¸€ä¸ªåŒåçš„æ–¹æ³•ï¼Œæ›´æ— æ³•ç›´æ¥åœ¨Java ç¨‹åºä¸­è°ƒç”¨è¯¥æ–¹æ³•ï¼Œè™½ç„¶è¯¥æ–¹æ³•ä¹Ÿæ˜¯ç”±å­—èŠ‚ç æŒ‡ä»¤æ‰€ç»„æˆã€‚
- **å®ƒæ˜¯ç”±ç±»é™æ€æˆå‘˜çš„èµ‹å€¼è¯­å¥ä»¥åŠ static è¯­å¥å—åˆå¹¶äº§ç”Ÿçš„ã€‚**

æ³¨: è™šæ‹Ÿæœºä¼šä¿è¯ <clinit>() æ–¹æ³•çš„çº¿ç¨‹å®‰å…¨æ€§,å¸¦éšå¼çš„é”

#### 2) åˆå§‹åŒ–æ—¶æœº 

æ¦‚æ‹¬å¾—è¯´ï¼Œç±»åˆå§‹åŒ–æ˜¯ã€æ‡’æƒ°çš„ã€‘

- main æ–¹æ³•æ‰€åœ¨çš„ç±»ï¼Œæ€»ä¼šè¢«é¦–å…ˆåˆå§‹åŒ–
- é¦–æ¬¡è®¿é—®è¿™ä¸ªç±»çš„é™æ€å˜é‡æˆ–é™æ€æ–¹æ³•æ—¶
- å­ç±»åˆå§‹åŒ–ï¼Œå¦‚æœçˆ¶ç±»è¿˜æ²¡åˆå§‹åŒ–ï¼Œä¼šå¼•å‘
- å­ç±»è®¿é—®çˆ¶ç±»çš„é™æ€å˜é‡ï¼Œåªä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–
- Class.forName
- new ä¼šå¯¼è‡´åˆå§‹åŒ–

ä¸ä¼šè§¦å‘åˆå§‹åŒ–çš„æƒ…å†µ

- è®¿é—®ç±»çš„ static final é™æ€å¸¸é‡ï¼ˆåŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²ï¼‰ä¸ä¼šè§¦å‘åˆå§‹åŒ–
- ç±»å¯¹è±¡.class ä¸ä¼šè§¦å‘åˆå§‹åŒ–
- åˆ›å»ºè¯¥ç±»çš„æ•°ç»„ä¸ä¼šè§¦å‘åˆå§‹åŒ–
- ç±»åŠ è½½å™¨çš„ loadClass æ–¹æ³•
- Class.forName çš„å‚æ•° 2 ä¸º false æ—¶

### 3.4 ç±»çš„ä½¿ç”¨

å¼€å‘è€…å¼€å‘é˜¶æ®µéƒ½æ˜¯åœ¨ä½¿ç”¨ç±»

### 3.5 ç±»çš„å¸è½½

#### ç±»ä¸å®ä¾‹,ç±»ä¸ç±»åŠ è½½å™¨ä¹‹é—´çš„å…³ç³»

ç±»ä¸å®ä¾‹:

<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220823113205458.png" alt="image-20220823113205458" style="zoom:67%;" />

ç±»ä¸ç±»åŠ è½½å™¨:

åœ¨ç±»åŠ è½½å™¨çš„å†…éƒ¨å®ç°ä¸­ï¼Œç”¨ä¸€ä¸ª Java é›†åˆæ¥å­˜æ”¾æ‰€åŠ è½½ç±»çš„å¼•ç”¨ã€‚å¦ä¸€æ–¹é¢ï¼Œä¸€ä¸ª Class å¯¹è±¡æ€»æ˜¯ä¼šå¼•ç”¨å®ƒçš„ç±»åŠ è½½å™¨ï¼Œè°ƒç”¨ Class å¯¹è±¡çš„ getClassLoader() æ–¹æ³•ï¼Œ å°±èƒ½è·å¾—å®ƒçš„ç±»åŠ è½½å™¨ã€‚ç”±æ­¤å¯è§ï¼Œä»£è¡¨æŸä¸ªç±»çš„ Class å®ä¾‹ä¸å…¶ç±»çš„åŠ 
è½½å™¨ä¹‹é—´ä¸ºåŒå‘å…³è”å…³ç³»ã€‚

#### æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶

æ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ä¸»è¦å›æ”¶ä¸¤éƒ¨åˆ†å†…å®¹:**å¸¸é‡æ± ä¸­åºŸå¼ƒçš„å¸¸é‡å’Œä¸å†ä½¿ç”¨çš„ç±»å‹ã€‚**

HotSpotè™šæ‹Ÿæœºå¯¹å¸¸é‡æ± çš„å›æ”¶ç­–ç•¥æ˜¯å¾ˆæ˜ç¡®çš„ï¼Œåªè¦å¸¸é‡æ± ä¸­çš„å¸¸é‡æ²¡æœ‰è¢«ä»»ä½•åœ°æ–¹å¼•ç”¨ï¼Œå°±å¯ä»¥è¢«å›æ”¶ã€‚

åˆ¤å®šä¸€ä¸ªå¸¸é‡æ˜¯å¦â€œåºŸå¼ƒâ€è¿˜æ˜¯ç›¸å¯¹ç®€å•ï¼Œè€Œè¦**åˆ¤å®šä¸€ä¸ªç±»å‹æ˜¯å¦å±äºâ€œä¸å†è¢«ä½¿ç”¨çš„ç±»â€**çš„æ¡ä»¶å°±æ¯”è¾ƒè‹›åˆ»äº†ã€‚éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢ä¸‰ä¸ªæ¡ä»¶:

- è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ã€‚ä¹Ÿå°±æ˜¯Javaå †ä¸­ä¸å­˜åœ¨è¯¥ç±»åŠå…¶ä»»ä½•æ´¾ç”Ÿå­ç±»çš„å®ä¾‹ã€‚
- åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨å·²ç»è¢«å›æ”¶ã€‚è¿™ä¸ªæ¡ä»¶é™¤éæ˜¯ç»è¿‡ç²¾å¿ƒè®¾è®¡çš„å¯æ›¿æ¢ç±»åŠ è½½å™¨çš„åœºæ™¯ï¼Œå¦‚OSGiã€JSPçš„é‡åŠ è½½ç­‰ï¼Œå¦åˆ™é€šå¸¸æ˜¯å¾ˆéš¾è¾¾æˆçš„ã€‚
- è¯¥ç±»å¯¹åº”çš„java.lang.Classå¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚

Java è™šæ‹Ÿæœºè¢«å…è®¸å¯¹æ»¡è¶³ä¸Šè¿°ä¸‰ä¸ªæ¡ä»¶çš„æ— ç”¨ç±»è¿›è¡Œå›æ”¶ï¼Œè¿™é‡Œè¯´çš„ä»…ä»…æ˜¯â€œè¢«å…è®¸â€ï¼Œè€Œå¹¶ä¸æ˜¯å’Œå¯¹è±¡ä¸€æ ·ï¼Œæ²¡æœ‰å¼•ç”¨äº†å°±å¿…ç„¶ä¼šå›æ”¶ã€‚



## 4.ç±»åŠ è½½å™¨

ç±»åŠ è½½å™¨æ˜¯ JVM æ‰§è¡Œç±»åŠ è½½æœºåˆ¶çš„å‰æ

### 4.1 ClassLoader çš„ä½œç”¨

ClassLoader æ˜¯ Java æ ¸å¿ƒç»„ä»¶,æ‰€æœ‰çš„ Class éƒ½æ˜¯ç”± ClassLoader è¿›è¡ŒåŠ è½½çš„, ClassLoader è´Ÿè´£é€šè¿‡å„ç§æ–¹å¼å°† Class ä¿¡æ¯çš„äºŒè¿›åˆ¶æ•°æ®æµè¯»å…¥ Jvm å†…éƒ¨,è½¬æ¢ä¸ºä¸€ä¸ªä¸ç›®æ ‡ç±»å¯¹åº”çš„ java.lang.Class å¯¹è±¡çš„å®ä¾‹,ç„¶åäº¤ç»™ Java è™šæ‹Ÿæœºè¿›è¡Œé“¾æ¥,åˆå§‹åŒ–,ç­‰æ“ä½œ.å› æ­¤, ClassLoader åœ¨æ•´ä¸ªè£…è½½é˜¶æ®µ,åªèƒ½å½±å“åˆ°ç±»çš„åŠ è½½,è€Œæ— æ³•é€šè¿‡ ClassLoader å»æ”¹å˜ç±»çš„é“¾æ¥çŠ¶æ€å’Œåˆå§‹åŒ–è¡Œä¸º.è‡³äºæ˜¯å¦å¯ä»¥è¿è¡Œ,ç”±æ‰§è¡Œå¼•æ“å†³å®š.

<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220823122421587.png" alt="image-20220823122421587" style="zoom:67%;" />

### 4.2 ç±»åŠ è½½å™¨åˆ†ç±»

<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220823123555191.png" alt="image-20220823123555191" style="zoom:67%;" />

- é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”å½“æœ‰è‡ªå·±çš„â€œçˆ¶ç±»â€åŠ è½½å™¨ã€‚
- ä¸åŒç±»åŠ è½½å™¨çœ‹ä¼¼æ˜¯ç»§æ‰¿(Inheritance)å…³ç³»ï¼Œå®é™…ä¸Šæ˜¯åŒ…å«å…³ç³»ã€‚åœ¨ä¸‹å±‚åŠ è½½å™¨ä¸­ï¼ŒåŒ…å«ç€ä¸Šå±‚åŠ è½½å™¨çš„å¼•ç”¨

#### 1) å¯åŠ¨ç±»åŠ è½½å™¨(å¼•å¯¼ç±»åŠ è½½å™¨,Bootstrap ClassLoader)

- åŠ è½½æ ¸å¿ƒåº“,åŠ è½½æ‰©å±•ç±»åŠ è½½å™¨å’Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨,å¹¶æŒ‡å®šä»–ä»¬çš„çˆ¶ç±»åŠ è½½å™¨

- ä½¿ç”¨ C/C++ è¯­è¨€å®ç°,åµŒå¥—åœ¨ JVM å†…éƒ¨

- ç”¨æ¥åŠ è½½ Java çš„æ ¸å¿ƒåº“ (JAVA_ HOME/jre/lib/rt.jaræˆ–sun.boot.class.path) è·¯å¾„ä¸‹çš„å†…å®¹,ç”¨äºæä¾› JVM è‡ªèº«éœ€è¦çš„ç±»

- ä¸ç»§æ‰¿è‡ª ClassLoader ,æ²¡æœ‰çˆ¶ç±»åŠ è½½å™¨

  

#### 2) æ‰©å±•ç±»åŠ è½½å™¨(Extension ClassLoader)

- ç”¨æ¥åŠ è½½ Java çš„æ‰©å±•åº“

- Java è¯­è¨€ç¼–å†™
- ç»§æ‰¿äº ClassLoader ç±»
- çˆ¶ç±»åŠ è½½å™¨ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨
- ä» java.ext.dirs ç³»ç»Ÿå±æ€§æ‰€æŒ‡å®šçš„ç›®å½•ä¸­åŠ è½½ç±»åº“ï¼Œæˆ–ä» JDK çš„å®‰è£…ç›®å½•çš„ jre/lib/ext å­ç›®å½•ä¸‹åŠ è½½ç±»åº“ã€‚å¦‚æœç”¨æˆ·åˆ›å»ºçš„ JAR æ”¾åœ¨æ­¤ç›®å½•ä¸‹ï¼Œä¹Ÿä¼šè‡ªåŠ¨ç”±æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½ã€‚

#### 3) åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨(Application ClassLoader)

- å®ƒè´Ÿè´£åŠ è½½ç¯å¢ƒå˜é‡ classpath æˆ–ç³»ç»Ÿå±æ€§ java.class.path æŒ‡å®šè·¯å¾„ä¸‹çš„ç±»åº“

- java è¯­è¨€ç¼–å†™ï¼Œç”± sun.misc.Launcher$AppClassLoader å®ç°
- ç»§æ‰¿äº ClassLoader ç±»
- çˆ¶ç±»åŠ è½½å™¨ä¸ºæ‰©å±•ç±»åŠ è½½å™¨
- åº”ç”¨ç¨‹åºä¸­çš„ç±»åŠ è½½å™¨é»˜è®¤æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚
- å®ƒæ˜¯ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„é»˜è®¤çˆ¶åŠ è½½å™¨
- é€šè¿‡ ClassLoader çš„ getSystemClassLoader() æ–¹æ³•å¯ä»¥è·å–åˆ°è¯¥ç±»åŠ è½½å™¨

#### 4) ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨

- åœ¨ Java çš„æ—¥å¸¸åº”ç”¨ç¨‹åºå¼€å‘ä¸­ï¼Œç±»çš„åŠ è½½å‡ ä¹æ˜¯ç”±ä¸Šè¿°3ç§ç±»åŠ è½½å™¨ç›¸äº’é…åˆæ‰§è¡Œçš„ã€‚åœ¨å¿…è¦æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œæ¥å®šåˆ¶ç±»çš„åŠ è½½æ–¹å¼ã€‚
- ä½“ç° Java è¯­è¨€å¼ºå¤§ç”Ÿå‘½åŠ›å’Œå·¨å¤§é­…åŠ›çš„å…³é”®å› ç´ ä¹‹ä¸€ä¾¿æ˜¯, Java å¼€å‘è€…å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥å®ç°ç±»åº“çš„åŠ¨æ€åŠ è½½ï¼ŒåŠ è½½æºå¯ä»¥æ˜¯æœ¬åœ°çš„ JAR åŒ…ï¼Œä¹Ÿå¯ä»¥æ˜¯ç½‘ç»œä¸Šçš„è¿œç¨‹èµ„æºã€‚
- é€šè¿‡ç±»åŠ è½½å™¨å¯ä»¥å®ç°éå¸¸ç»å¦™çš„æ’ä»¶æœºåˆ¶ï¼Œè¿™æ–¹é¢çš„å®é™…åº”ç”¨æ¡ˆä¾‹ä¸¾ä¸èƒœä¸¾ã€‚ä¾‹å¦‚ï¼Œè‘—åçš„ OSGI ç»„ä»¶æ¡†æ¶ï¼Œå†å¦‚ Eclipse çš„æ’ä»¶æœºåˆ¶ã€‚ç±»åŠ è½½å™¨ä¸ºåº”ç”¨ç¨‹åºæä¾›äº†ä¸€ç§åŠ¨æ€å¢åŠ æ–°åŠŸèƒ½çš„æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶æ— é¡»é‡æ–°æ‰“åŒ…å‘å¸ƒåº”ç”¨ç¨‹åºå°±èƒ½å®ç°ã€‚
- åŒæ—¶ï¼Œè‡ªå®šä¹‰åŠ è½½å™¨èƒ½å¤Ÿå®ç°**åº”ç”¨éš”ç¦»**ï¼Œä¸åŒåº”ç”¨çš„åŒåç±»éƒ½å¯ä»¥åŠ è½½ï¼Œä¸å†²çªï¼Œå¸¸è§äº tomcat å®¹å™¨
- è‡ªå®šä¹‰ç±»åŠ è½½å™¨é€šå¸¸éœ€è¦ç»§æ‰¿äºClassLoaderã€‚

æ­¥éª¤: 

1. ç»§æ‰¿ ClassLoader çˆ¶ç±»
2. è¦éµä»åŒäº²å§”æ´¾æœºåˆ¶ï¼Œé‡å†™ findClass æ–¹æ³•
    æ³¨æ„ä¸æ˜¯é‡å†™ loadClass æ–¹æ³•ï¼Œå¦åˆ™ä¸ä¼šèµ°åŒäº²å§”æ´¾æœºåˆ¶
3. è¯»å–ç±»æ–‡ä»¶çš„å­—èŠ‚ç 
4. è°ƒç”¨çˆ¶ç±»çš„ defineClass æ–¹æ³•æ¥åŠ è½½ç±»
5. ä½¿ç”¨è€…è°ƒç”¨è¯¥ç±»åŠ è½½å™¨çš„ loadClass æ–¹æ³•

å®ä¾‹:

```java
class MyClassLoader extends ClassLoader {
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {

            String path = "class æ–‡ä»¶è·¯å¾„";
            //è·å¾—å­—èŠ‚ç æ–‡ä»¶çš„è¾“å…¥æµ
            // ....
            ByteArrayOutputStream os = new ByteArrayOutputStream();
            Files.copy(Paths.get(path), os);

            byte[] bytes = os.toByteArray();
            // bytes -> *.class
            return defineClass(name, bytes, 0, bytes.length);
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
}


// æµ‹è¯•

  public static void main(String[] args) throws ClassNotFoundException, NoSuchFieldException,    InstantiationException, IllegalAccessException {
        MyClassLoader loader = new MyClassLoader();
        Class<?> test = loader.loadClass("org.snbo.complier.TestMain");

        Field a = test.getField("a");
        Field b = test.getField("b");
        //é™æ€å˜é‡
        System.out.println(a.get(test));
        //é™æ€å˜é‡
        System.out.println(b.get(test));
    }
```



### 4.3 åŒäº²å§”æ´¾æ¨¡å‹

å®šä¹‰: 

å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨åœ¨æ¥åˆ°åŠ è½½ç±»çš„è¯·æ±‚æ—¶ï¼Œå®ƒé¦–å…ˆ**ä¸ä¼šè‡ªå·±å°è¯•å»åŠ è½½è¿™ä¸ªç±»**ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚ä»»åŠ¡å§”æ‰˜ç»™çˆ¶åŠ è½½å™¨å»å®Œæˆï¼Œä¾æ¬¡é€’å½’ï¼Œå¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±æˆåŠŸè¿”å›ã€‚**åªæœ‰çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤åŠ è½½ä»»åŠ¡æ—¶ï¼Œæ‰è‡ªå·±å»åŠ è½½ã€‚**

- è§„å®šäº†ç±»åŠ è½½çš„é¡ºåºæ˜¯:å¼•å¯¼ç±»åŠ è½½å™¨å…ˆåŠ è½½ï¼Œè‹¥åŠ è½½ä¸åˆ°ï¼Œç”±æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½ï¼Œè‹¥è¿˜åŠ è½½ä¸åˆ°ï¼Œæ‰ä¼šç”±ç³»ç»Ÿç±»åŠ è½½å™¨æˆ–è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚

<img src="D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220823170532333.png" alt="image-20220823170532333" style="zoom:67%;" />

#### 1) åŒäº²å§”æ´¾æœºåˆ¶ä¼˜åŠ¿

- é¿å…ç±»çš„é‡å¤åŠ è½½,ç¡®ä¿ä¸€ä¸ªç±»çš„å…¨å±€å”¯ä¸€æ€§(Java ç±»éšç€å®ƒçš„ç±»åŠ è½½å™¨ä¸€èµ·å…·å¤‡äº†ä¸€ç§å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³»ï¼Œé€šè¿‡è¿™ç§å±‚çº§å…³å¯ä»¥é¿å…ç±»çš„é‡å¤åŠ è½½ï¼Œå½“çˆ¶äº²å·²ç»åŠ è½½äº†è¯¥ç±»æ—¶ï¼Œå°±æ²¡æœ‰å¿…è¦å­ ClassLoader å†åŠ è½½ä¸€æ¬¡)
- ä¿æŠ¤ç¨‹åºå®‰å…¨,é˜²æ­¢æ ¸å¿ƒ API è¢«éšæ„ç¯¡æ”¹

#### 2) ä»£ç æ”¯æŒ

åŒäº²å§”æ´¾æœºåˆ¶åœ¨ java.lang.ClassLoader.loadClass (String, boolean) æ¥å£ä¸­ä½“ç°ã€‚è¯¥æ¥å£çš„é€»è¾‘å¦‚ä¸‹:

1. å…ˆåœ¨å½“å‰åŠ è½½å™¨çš„ç¼“å­˜ä¸­æŸ¥æ‰¾æœ‰æ— ç›®æ ‡ç±»ï¼Œå¦‚æœæœ‰ï¼Œç›´æ¥è¿”å›ã€‚
2. åˆ¤æ–­å½“å‰åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ parent.loadClass(name, false) æ¥å£è¿›è¡ŒåŠ è½½ã€‚
3. åä¹‹ï¼Œå¦‚æœå½“å‰åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ findBootstrapClassOrNu1l(name) æ¥å£ï¼Œè®©å¼•å¯¼ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚
4. å¦‚æœé€šè¿‡ä»¥ä¸Š3æ¡è·¯å¾„éƒ½æ²¡èƒ½æˆåŠŸåŠ è½½ï¼Œåˆ™è°ƒç”¨findClass (name )æ¥å£è¿›è¡ŒåŠ è½½ã€‚è¯¥æ¥å£æœ€ç»ˆä¼šè°ƒç”¨
   java.lang.ClassLoader æ¥å£çš„ defineClass ç³»åˆ—çš„ native æ¥å£åŠ è½½ç›®æ ‡ Java ç±»ã€‚
   åŒäº²å§”æ´¾çš„æ¨¡å‹å°±éšè—åœ¨è¿™ç¬¬2å’Œç¬¬3æ­¥ä¸­ã€‚

#### 3) åŒäº²å§”æ´¾æœºåˆ¶åŠ£åŠ¿

å§”æ‰˜è¿‡ç¨‹æ˜¯å•å‘çš„,ä¸Šå±‚ ClassLoader æ— æ³•è®¿é—®ä¸‹å±‚ ClassLoader æ‰€åŠ è½½çš„ç±»

ç»“è®º:

ç”±äºJavaè™šæ‹Ÿæœºè§„èŒƒå¹¶æ²¡æœ‰æ˜ç¡®è¦æ±‚ç±»åŠ è½½å™¨çš„åŠ è½½æœºåˆ¶ä¸€å®šè¦ä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹ï¼Œåªæ˜¯å»ºè®®é‡‡ç”¨è¿™ç§æ–¹å¼è€Œå·²ã€‚æ¯”å¦‚åœ¨Tomcatä¸­ï¼Œç±»åŠ è½½å™¨æ‰€é‡‡ç”¨çš„åŠ è½½æœºåˆ¶å°±å’Œä¼ ç»Ÿçš„åŒäº²å§”æ´¾æ¨¡å‹æœ‰ä¸€å®šåŒºåˆ«ï¼Œå½“ç¼ºçœçš„ç±»åŠ è½½å™¨æ¥æ”¶åˆ°ä¸€ä¸ªç±»çš„åŠ è½½ä»»åŠ¡æ—¶ï¼Œé¦–å…ˆä¼šç”±å®ƒè‡ªè¡ŒåŠ è½½ï¼Œå½“å®ƒåŠ è½½å¤±è´¥æ—¶ï¼Œæ‰ä¼šå°†ç±»çš„åŠ è½½ä»»åŠ¡å§”æ´¾ç»™å®ƒçš„è¶…ç±»åŠ è½½å™¨å»æ‰§è¡Œï¼Œè¿™åŒæ—¶ä¹Ÿæ˜¯Servletè§„èŒƒæ¨èçš„ä¸€ç§åšæ³•ã€‚

### 4.4 çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨

æˆ‘ä»¬åœ¨ä½¿ç”¨ JDBC æ—¶ï¼Œéƒ½éœ€è¦åŠ è½½ Driver é©±åŠ¨ï¼Œä¸çŸ¥é“ä½ æ³¨æ„åˆ°æ²¡æœ‰ï¼Œä¸å†™

```java
Class.forName("com.mysql.jdbc.Driver")
```

ä¹Ÿæ˜¯å¯ä»¥è®© com.mysql.jdbc.Driver æ­£ç¡®åŠ è½½çš„ï¼Œä½ çŸ¥é“æ˜¯æ€ä¹ˆåšçš„å—ï¼Ÿ

è®©æˆ‘ä»¬è¿½è¸ªä¸€ä¸‹æºç ï¼š

```java
public class DriverManager {
	// æ³¨å†Œé©±åŠ¨çš„é›†åˆ
	private final static CopyOnWriteArrayList<DriverInfo> registeredDrivers
	= new CopyOnWriteArrayList<>();
	// åˆå§‹åŒ–é©±åŠ¨
	static {
		loadInitialDrivers();
		println("JDBC DriverManager initialized");
    }
}
```

å…ˆä¸çœ‹åˆ«çš„ï¼Œçœ‹çœ‹ DriverManager çš„ç±»åŠ è½½å™¨ï¼š

```java
System.out.println(DriverManager.class.getClassLoader());
```

æ‰“å° nullï¼Œè¡¨ç¤ºå®ƒçš„ç±»åŠ è½½å™¨æ˜¯ Bootstrap ClassLoaderï¼Œä¼šåˆ° JAVA_HOME/jre/lib ä¸‹æœç´¢ç±»ï¼Œä½†
JAVA_HOME/jre/lib ä¸‹æ˜¾ç„¶æ²¡æœ‰ mysql-connector-java-5.1.47.jar åŒ…ï¼Œè¿™æ ·é—®é¢˜æ¥äº†ï¼Œåœ¨
DriverManager çš„é™æ€ä»£ç å—ä¸­ï¼Œæ€ä¹ˆèƒ½æ­£ç¡®åŠ è½½ com.mysql.jdbc.Driver å‘¢ï¼Ÿ

ç»§ç»­çœ‹ loadInitialDrivers() æ–¹æ³•ï¼š

```java
   
   private static void loadInitialDrivers() {
        String drivers;
        try {
            drivers = AccessController.doPrivileged(new PrivilegedAction<String>
                    () {
                public String run() {
                    return System.getProperty("jdbc.drivers");
                }
            });
        } catch (Exception ex) {
            drivers = null;
        }
        // 1ï¼‰ä½¿ç”¨ ServiceLoader æœºåˆ¶åŠ è½½é©±åŠ¨ï¼Œå³ SPI
        AccessController.doPrivileged(new PrivilegedAction<Void>() {
            public Void run() {
                ServiceLoader<Driver> loadedDrivers =
                        ServiceLoader.load(Driver.class);
                Iterator<Driver> driversIterator = loadedDrivers.iterator();
                try{
                    while(driversIterator.hasNext()) {
                        driversIterator.next();
                    }
                } catch(Throwable t) {
                // Do nothing
                }
                return null;
            }
        });
        println("DriverManager.initialize: jdbc.drivers = " + drivers);
        // 2ï¼‰ä½¿ç”¨ jdbc.drivers å®šä¹‰çš„é©±åŠ¨ååŠ è½½é©±åŠ¨
        if (drivers == null || drivers.equals("")) {
            return;
        }
        String[] driversList = drivers.split(":");
        println("number of Drivers:" + driversList.length);
        for (String aDriver : driversList) {
            try {
                println("DriverManager.Initialize: loading " + aDriver);
                // è¿™é‡Œçš„ ClassLoader.getSystemClassLoader() å°±æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨
                Class.forName(aDriver, true,
                        ClassLoader.getSystemClassLoader());
            } catch (Exception ex) {
                println("DriverManager.Initialize: load failed: " + ex);
            }
        }
    }
```

- å…ˆçœ‹ 2ï¼‰å‘ç°å®ƒæœ€åæ˜¯ä½¿ç”¨ Class.forName å®Œæˆç±»çš„åŠ è½½å’Œåˆå§‹åŒ–ï¼Œå…³è”çš„æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œå› æ­¤
  å¯ä»¥é¡ºåˆ©å®Œæˆç±»åŠ è½½
- å†çœ‹ 1ï¼‰å®ƒå°±æ˜¯å¤§åé¼é¼çš„ Service Provider Interface ï¼ˆSPIï¼‰
  çº¦å®šå¦‚ä¸‹ï¼Œåœ¨ jar åŒ…çš„ META-INF/services åŒ…ä¸‹ï¼Œä»¥æ¥å£å…¨é™å®šååä¸ºæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯å®ç°ç±»åç§°

![image-20220824202335431](D:\A.å­¦ä¹ èµ„æ–™\A.ç¬”è®°\1. JVM\assets\image-20220824202335431.png)

è¿™æ ·å°±å¯ä»¥ä½¿ç”¨

```java
ServiceLoader<æ¥å£ç±»å‹> allImpls = ServiceLoader.load(æ¥å£ç±»å‹.class);
Iterator<æ¥å£ç±»å‹> iter = allImpls.iterator();
while(iter.hasNext()) {
    iter.next();
}
```

æ¥å¾—åˆ°å®ç°ç±»ï¼Œä½“ç°çš„æ˜¯ã€é¢å‘æ¥å£ç¼–ç¨‹+è§£è€¦ã€‘çš„æ€æƒ³ï¼Œåœ¨ä¸‹é¢ä¸€äº›æ¡†æ¶ä¸­éƒ½è¿ç”¨äº†æ­¤æ€æƒ³ï¼š

- JDBC
- Servlet åˆå§‹åŒ–å™¨
- Spring å®¹å™¨
- Dubboï¼ˆå¯¹ SPI è¿›è¡Œäº†æ‰©å±•ï¼‰

çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨æ˜¯å½“å‰çº¿ç¨‹ä½¿ç”¨çš„ç±»åŠ è½½å™¨ï¼Œé»˜è®¤å°±æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œå®ƒå†…éƒ¨åˆæ˜¯ç”±
Class.forName è°ƒç”¨äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å®Œæˆç±»åŠ è½½.

æ€»ç»“: è™½ç„¶ DiverManager æ˜¯ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„,ä½†æ˜¯å†…éƒ¨åŠ è½½ Mysql é©±åŠ¨çš„æ—¶å€™,ç”¨äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨(é»˜è®¤ä¸ºåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨)æ¥åŠ è½½,å³æ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶



## 5.è¿è¡ŒæœŸä¼˜åŒ–

### 5.1 å³æ—¶ç¼–è¯‘

#### åˆ†å±‚ç¼–è¯‘

JVM å°†æ‰§è¡ŒçŠ¶æ€åˆ†æˆäº† 5 ä¸ªå±‚æ¬¡ï¼š

- 0 å±‚ï¼Œè§£é‡Šæ‰§è¡Œï¼ˆInterpreterï¼‰
- 1 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆä¸å¸¦ profilingï¼‰
- 2 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆå¸¦åŸºæœ¬çš„ profilingï¼‰
- 3 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆå¸¦å®Œå…¨çš„ profilingï¼‰
- 4 å±‚ï¼Œä½¿ç”¨ C2 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œ

profiling æ˜¯æŒ‡åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ”¶é›†ä¸€äº›ç¨‹åºæ‰§è¡ŒçŠ¶æ€çš„æ•°æ®ï¼Œä¾‹å¦‚ã€æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ã€‘ï¼Œã€å¾ªç¯çš„
å›è¾¹æ¬¡æ•°ã€‘ç­‰

##### å³æ—¶ç¼–è¯‘å™¨ï¼ˆJITï¼‰ä¸è§£é‡Šå™¨çš„åŒºåˆ«

- è§£é‡Šå™¨æ˜¯å°†å­—èŠ‚ç è§£é‡Šä¸ºæœºå™¨ç ï¼Œä¸‹æ¬¡å³ä½¿é‡åˆ°ç›¸åŒçš„å­—èŠ‚ç ï¼Œä»ä¼šæ‰§è¡Œ**é‡å¤çš„è§£é‡Š**
- JIT æ˜¯å°†ä¸€äº›å­—èŠ‚ç ç¼–è¯‘ä¸ºæœºå™¨ç ï¼Œ**å¹¶å­˜å…¥ Code Cacheï¼Œä¸‹æ¬¡é‡åˆ°ç›¸åŒçš„ä»£ç ï¼Œç›´æ¥æ‰§è¡Œï¼Œæ— éœ€**
  **å†ç¼–è¯‘.** 
- è§£é‡Šå™¨æ˜¯å°†å­—èŠ‚ç è§£é‡Šä¸ºé’ˆå¯¹æ‰€æœ‰å¹³å°éƒ½é€šç”¨çš„æœºå™¨ç 
- **JIT ä¼šæ ¹æ®å¹³å°ç±»å‹ï¼Œç”Ÿæˆå¹³å°ç‰¹å®šçš„æœºå™¨ç **

å¯¹äºå æ®å¤§éƒ¨åˆ†çš„ä¸å¸¸ç”¨çš„ä»£ç ï¼Œæˆ‘ä»¬æ— éœ€è€—è´¹æ—¶é—´å°†å…¶ç¼–è¯‘æˆæœºå™¨ç ï¼Œè€Œæ˜¯é‡‡å–è§£é‡Šæ‰§è¡Œçš„æ–¹å¼è¿
è¡Œï¼›å¦ä¸€æ–¹é¢ï¼Œå¯¹äºä»…å æ®å°éƒ¨åˆ†çš„çƒ­ç‚¹ä»£ç ï¼Œæˆ‘ä»¬åˆ™å¯ä»¥å°†å…¶ç¼–è¯‘æˆæœºå™¨ç ï¼Œä»¥è¾¾åˆ°ç†æƒ³çš„è¿è¡Œé€Ÿ
åº¦ã€‚ æ‰§è¡Œæ•ˆç‡ä¸Šç®€å•æ¯”è¾ƒä¸€ä¸‹ Interpreter < C1 < C2ï¼Œæ€»çš„ç›®æ ‡æ˜¯å‘ç°çƒ­ç‚¹ä»£ç ï¼ˆhotspotåç§°çš„ç”±
æ¥ï¼‰

#### é€ƒé€¸åˆ†æ

å‘ç°æ–°å»ºçš„å¯¹è±¡æ˜¯å¦é€ƒé€¸(æœ‰äº›æ–°å»ºçš„å¯¹è±¡å¹¶æ²¡æœ‰åœ¨åˆ«å¤„ä½¿ç”¨)ã€‚å¦‚æœå‘ç°é€ƒé€¸,ä¼šçœç•¥ä¸æ–°å»º

å¯ä»¥ä½¿ç”¨ -XX:-DoEscapeAnalysis å…³é—­é€ƒé€¸åˆ†æï¼Œå†è¿è¡Œåˆšæ‰çš„ç¤ºä¾‹è§‚å¯Ÿç»“æœ

#### æ–¹æ³•å†…è”

```java
private static int square(final int i) {
	return i * i;
}
```

```java
System.out.println(square(9));
```

å¦‚æœå‘ç° square æ˜¯çƒ­ç‚¹æ–¹æ³•ï¼Œå¹¶ä¸”é•¿åº¦ä¸å¤ªé•¿æ—¶ï¼Œä¼šè¿›è¡Œå†…è”ï¼Œæ‰€è°“çš„å†…è”å°±æ˜¯æŠŠæ–¹æ³•å†…ä»£ç æ‹·è´ã€
ç²˜è´´åˆ°è°ƒç”¨è€…çš„ä½ç½®ï¼š

```java
System.out.println(9 * 9);
//è¿›ä¸€æ­¥å¯¹å¸¸é‡è¿›è¡Œä¼˜åŒ–
System.out.println(81);
```

#### å­—æ®µä¼˜åŒ–

...

### 5.2 åå°„ä¼˜åŒ–
